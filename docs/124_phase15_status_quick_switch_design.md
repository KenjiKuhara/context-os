# 124 — Phase15-StatusQuickSwitch 設計

詳細画面で状態変更を「入力」ではなく「押す」に変え、0.5 秒で状態を切り替えられる体験を実現する。

**参照**: docs/05_State_Machine.md、docs/114_phase_status.md、POST /api/nodes/{id}/estimate-status。

---

## 1. 目的（速度最優先）

- 詳細画面で状態変更を**「入力」ではなく「押す」**に変える
- **0.5 秒**で状態を切り替えられること（思考を止めない）
- **A 方針**: 状態ボタンは「常に全部表示」

---

## 2. スコープ

- **対象**: /dashboard の詳細パネル（右側）の「状態」表示ブロック
- **変更しない**: 既存の状態遷移ロジック・推定（「何が起きた？」）・履歴・温度・API・DB
- **行うこと**: UI 追加 ＋ 既存状態更新 API 呼び出しのみ

---

## 3. UI 仕様（A：常に全部表示）

- 「状態： \<現在ラベル\>」の近くに、**状態ボタン群**を横並びで**常時表示**する
- ボタン群は、システムが持つ**全ステータスをすべて表示**する（隠さない）
  - 例: READY / IN_PROGRESS / DONE / BLOCKED / NEEDS_DECISION / NEEDS_REVIEW / COOLING / CANCELLED 等（stateMachine の ALL_STATUSES に従う）
- **現在の状態**は active（強調表示）
- **その他**は inactive（アウトライン）
- **クリック**でその状態へ変更する
- キーボード操作は MVP では必須にしない（後続フェーズ）

---

## 4. 動作仕様（最速：optimistic）

- ボタン押下で**即座に UI 上の状態ラベルを切り替える**（optimistic）
- バックグラウンドで**既存の状態更新 API** を呼ぶ  
  → **POST /api/nodes/{id}/estimate-status** を Apply モード（confirm_status 指定）で呼び出す。遷移検証・履歴は既存のまま。
- **API 待ちで UI を止めない**（await でブロックしない）
- **失敗時のみ**、元の状態に戻して「失敗」メッセージを表示する
- **確認ダイアログは出さない**（速度優先、戻せる前提）

---

## 5. 二重操作ガード（速度を落とさない）

- **連打で同じ状態を何度も送らない**: 現在状態のボタンは押せない（disabled）
- **API 送信中でも**入力や他操作は止めない
- **同一タスクに対して連続で別状態が押された場合**
  - 「最後に押した状態」を勝たせる（last-write-wins）
  - 途中のリクエスト結果で UI を巻き戻さない（requestId 等で整合）

---

## 6. トークン/デザイン制約（ダーク対応維持）

- 色は直書き禁止。必ず**セマンティックトークン**を使用する
- active / inactive / disabled の差が**ライト/ダーク両方**で一瞬で分かること

---

## 7. 完了条件（Exit Criteria）

| # | 条件 |
|---|------|
| 1 | 詳細画面に「全状態ボタン群」が常時表示されている |
| 2 | 現在状態が active で明確、他は inactive |
| 3 | ボタン押下で即時に状態が切り替わる（UI が止まらない） |
| 4 | 失敗時のみ元に戻り、失敗が分かる |
| 5 | 既存の推定/履歴/温度/文言は壊れていない |

---

## 参照ドキュメント

| 番号 | ファイル名 |
|------|------------|
| 05 | 05_State_Machine.md |
| 114 | 114_phase_status.md |
| - | src/lib/stateMachine.ts（ALL_STATUSES, STATUS_LABELS） |
| - | POST /api/nodes/{id}/estimate-status |

以上。Phase15-StatusQuickSwitch の設計とする。
