# 75 — Phase6 サマリ

Phase6 全体（Phase6-A / Phase6-B）の振り返りと到達点をまとめる。本ドキュメントは Phase7 以降の設計判断・講演・記事・説明用の参照、およびプロジェクトの区切り確認のための俯瞰資料とする。

---

## 1. Phase6 の位置づけ

### 目的

Phase6 は Phase5 までに構築したデータ構造（nodes.parent_id と node_children）を **UI として可視化・操作可能にする** ことを目的としたフェーズである。

### Phase5 までとの違い

- **Phase5 まで**: relation / grouping / decomposition により、データ構造・親子関係の Diff Apply は実装済み。Organizer タブでの Diff 表示・Apply はあるが、**一覧はフラット表示**である。
- **Phase6**: 構造を **ツリー表示** で見える形にし、開閉・キーボードナビ・詳細パネル連携を実装。Phase6-B で開閉状態の永続化まで行う。

### 到達点

**Phase5 までで「構造」を扱えるようになったコンテキスト OS が、Phase6 で「UI を持った OS」になった。** すなわち、ダッシュボードの一覧で親子関係をツリーとして表示し、ユーザーが開閉状態を維持したまま閲覧できるまでになった。

---

## 2. Phase6-A：ツリー可視化（UI）

### できるようになったこと

- **API**: `GET /api/dashboard` のレスポンスに `node_children`（parent_id, child_id, created_at）を追加。
- **ツリー構築**: フロントで `buildTree(nodes, node_children)` により表示順の TreeNode を生成。node_children 優先・parent_id は fallback。循環検知・深さ 5 まで。
- **表示**: 一覧で「フラット / ツリー」切替。ツリー時は親をルートに、子をインデント＋ガイド線で表示。開閉（▶/▼）、子件数表示。
- **詳細連携**: 行クリックで右側の詳細パネルにそのノードを表示。
- **キーボード**: ツリー領域フォーカス時のみ。→ で展開＋先頭子を選択。← で子のときは親を閉じて親を選択、親のときはサブツリー全体を閉じて選択はそのまま。↑↓ で表示順に前後のノードを選択。input/textarea 内では無視。
- **エラー時**: API 失敗時は既存のエラーメッセージ表示。ツリー用 state は初期値で崩れない。

### 技術的な要点

- **API**: `node_children` を取得し、テーブル未存在時はエラーを無視して空配列を返す。
- **buildTree**: `src/lib/dashboardTree.ts` に実装。真実は node_children 優先・parent_id は fallback。循環検知・MAX_DEPTH=5。
- **UI**: `TreeList.tsx` で開閉・子件数・インデント・薄いガイド線。`onSelectNode` で詳細パネル連携。

### MVP としての割り切り

以下は Phase6-A の範囲外であり、未対応である。

- ツリー上でのノード編集（タイトル変更・削除）
- ドラッグ＆ドロップでの並び替え・親変更
- 開閉状態の Undo やツリー操作の取り消し
- sibling_order や表示順の変更 UI
- 5 階層より深い部分の表示（無限ループ防止）
- フラット表示時は矢印キーは効かない（ツリーコンポーネントがマウントされないため）

### 参照ドキュメント

- 68_phase6_a_tree_ui_mvp.md
- 69_phase6_a_tree_ui_closeout.md

---

## 3. Phase6-B：ツリー開閉状態の永続化

### 解決したユーザー体験上の課題

- **refresh やダッシュボード再訪問後も、「さっき開いていたノード」が開いたままになる** ようにした。
- ユーザーが手動で開閉した結果が失われず、ツリーを「自分の見たい形」で維持できるようにした。

### MVP でやったこと

- 開いているノードの ID の集合（expandedSet）を localStorage（キー `kuharaos.tree.expanded.v1`）に保存。
- 保存・復元のタイミング: 開閉が変わるたびに保存。`/dashboard` を開いたとき、または dashboard データ取得直後に復元。
- 復元時は treeRoots に存在する ID だけを expandedSet に反映。存在しない ID（削除されたノード等）は無視。
- フラット表示時は保存・復元の対象外。

### やらなかったこと

| 項目 | 内容 |
|------|------|
| サーバ保存 | 開閉状態を API で送信したり DB に保存したりしない。ローカルのみ。 |
| Undo | 開閉操作の取り消しや「ひとつ前の開閉状態に戻す」は行わない。 |
| 並び替え・編集 | ノードの並び替え・親変更・タイトル編集は本テーマの範囲外。 |
| デバイス間同期 | 別ブラウザ・別端末との開閉状態の同期は行わない。 |
| トレー別の開閉 | トレー切替ごとに別の開閉状態を保存せず、1 キーで 1 セットの expanded を保持する。 |
| debounce / throttle | 開閉変更の都度すぐに保存する。遅延書き込みは行わない。 |

### localStorage 永続化という判断の位置づけ

- MVP では **ローカル保存（localStorage）** に限定した。同一ブラウザ・同一オリジン内で永続化できれば足りると判断。
- DB スキーマを変えずにフロントの state と保存先だけで完結できる。Phase6-A のツリー表示・キーボードナビを壊さずに小さく足せる。
- サーバ保存・デバイス間同期は Phase6-B の範囲外であり、次フェーズ以降の候補。

### 参照ドキュメント

- 70_phase6_b_scope.md
- 72_phase6_b_tree_state_persistence_plan.md
- 73_phase6_b_tree_state_persistence_e2e_result.md
- 74_phase6_b_tree_state_persistence_closeout.md

---

## 4. Phase6 の到達点まとめ

### できるようになったこと（UI 観点）

| 項目 | 内容 |
|------|------|
| ツリー表示 | decomposition で作った親子構造を一覧でツリー表示できる。フラット／ツリー切替可能。 |
| 開閉操作 | 親ノードの ▶/▼ で子を展開・閉じる。子件数表示。インデント＋ガイド線。 |
| キーボードナビ | ツリー領域フォーカス時、→←↑↓ で展開・閉じ・前後のノード選択。 |
| 詳細パネル連携 | ツリーの任意の行をクリックすると右側の詳細パネルにそのノードが表示される。 |
| 開閉状態の永続化 | リロード・再訪問後も開閉状態が復元される（localStorage）。 |

### まだやっていないこと

| 項目 | 内容 |
|------|------|
| ツリー上の編集 | ノードのリネーム・削除・親変更をツリー UI から行う。 |
| ドラッグで並び替え | 子の順序変更（sibling_order 更新）や親の付け替え。 |
| 開閉操作の Undo | 開閉操作の取り消しや「ひとつ前の開閉状態に戻す」。 |
| 深い階層の表示 | 5 階層より深い部分の表示オプションや遅延展開。 |
| 開閉状態のサーバ保存 | ログイン前提で「どの端末でも同じ開閉」を実現する。 |
| トレー別の開閉 | トレー切替ごとに別の開閉状態を保存する。 |

### Phase6 を完了と判断できる理由

- Phase6-A は 69（closeout）で完了宣言済み。ツリー表示・開閉・キーボードの DoD を満たしている。
- Phase6-B は 74（closeout）で完了宣言済み。開閉状態の永続化の DoD を満たしている。
- Phase6-B のスコープ doc（70）で定めた最初のテーマ「ツリーの開閉状態の永続化」のみを対象とし、その MVP は完了としている。

---

## 5. 次フェーズへの接続点

### Phase7 に自然につながるテーマ候補

| 候補 | 内容 |
|------|------|
| **判断履歴の可視化** | ユーザーが行った confirmation / 意思決定の履歴を一覧・ツリーで見えるようにする。 |
| **confirmation / diff の履歴 UI** | Organizer の Diff Apply だけでなく、過去に適用した Diff や確認履歴を辿れる UI。 |
| **意思決定を辿れる OS への発展** | ツリーと履歴を組み合わせ、「なぜこの構造になったか」を追跡できるようにする。 |
| **ツリー上の編集** | ノードのリネーム・削除・親変更をツリー UI から行う（69 の引き継ぎ）。 |
| **ドラッグで並び替え** | 子の順序変更（sibling_order 更新）や親の付け替え。 |
| **開閉状態のサーバ保存** | 開閉状態を API で送信し、ユーザーまたはワークスペースに紐づけて DB に保存する。 |

### 今すぐやらないこと

- Phase6-A の範囲外（編集・ドラッグ・Undo・並び替え）は Phase7 以降の計画に含める。
- Phase6-B の 2 本目以降の候補（ツリー上でのノード編集、ドラッグで並び替え、深さ制限の拡張、ツリーとトレーの統合表示）は Phase6-B の範囲外であり、次フェーズでの検討対象とする。

---

## 6. 参照ドキュメント一覧

Phase6-A / Phase6-B に関係する md を番号付きで列挙する。

| 番号 | ファイル名 |
|------|-------------|
| 68 | 68_phase6_a_tree_ui_mvp.md |
| 69 | 69_phase6_a_tree_ui_closeout.md |
| 70 | 70_phase6_b_scope.md |
| 71 | 71_md_operation_policy.md |
| 72 | 72_phase6_b_tree_state_persistence_plan.md |
| 73 | 73_phase6_b_tree_state_persistence_e2e_result.md |
| 74 | 74_phase6_b_tree_state_persistence_closeout.md |

---

以上。Phase6 のサマリとして、Phase6 で「何ができるようになり、どこまで到達したか」を整理した。
