# 133‗Flat View Due Date & Sorting Specification

## 1. 背景

現状の仕様では以下が未整理、または曖昧である：

- フラット表示のソート基準が固定されていない
- 期日なしタスクの扱いが明確でない
- 期限切れ・今日・3日以内の判定基準が未固定
- 色表示が選択状態（青）と干渉する可能性がある
- タイムゾーンの基準が未定義

本ドキュメントで、フラット表示における
**期日ソートと視覚強調の完全仕様を定義する。**

---

# 2. 適用対象

- フラット表示（Tree表示ではない一覧表示）
- デフォルトソート
- 期日の視覚強調ロジック

ツリー表示には適用しない（将来検討）。

---

# 3. データ前提

## 3.1 due_date

- 型：`date` 推奨（時刻なし）
- null は「期日なし」
- 比較はローカル日付（Asia/Tokyo）基準

## 3.2 updated_at

- 最終更新日時
- 第2ソートキーとして使用

---

# 4. フラット表示のソート仕様

## 優先順位

### 優先1：due_date の有無

1. due_date が **ある** タスクを上に表示
2. due_date が **null** のタスクは後に表示

---

### 優先2：due_date 昇順

due_date があるタスク同士は：

- 日付が近い順（昇順）

例：
2026-02-10  
2026-02-14  
2026-03-01  

---

### 優先3：updated_at 降順

以下の場合は updated_at の新しい順（降順）：

- due_date が同日のタスク
- due_date が null のタスク

---

# 5. 期日の視覚強調ルール

## 基準日

- ローカル日付（Asia/Tokyo）
- today = 現在日付（時間切り捨て）

---

## 色分けルール

### 🔴 赤（最優先）

due_date <= today


対象：
- 期限切れ
- 今日が期日

---

### 🟡 黄色（注意）

today < due_date <= today + 3日


※ 今日を除く未来3日以内

---

### ⚪ 通常

- due_date > today + 3日
- due_date == null

---

# 6. UI仕様

## 表示方法

背景全面塗りは禁止（選択状態が青のため干渉する）。

推奨：

- 行の左端に 2〜4px のカラーバー
  または
- タイトル横に小さなバッジ

---

## 色の優先度

- 赤は最も強い視認性
- 黄色は赤より弱いトーン
- 青（選択状態）と視覚的に衝突しないこと

---

# 7. 実装要件

## 7.1 判定関数の分離

getDueStatus(due_date, now)
→ "overdue" | "soon" | "none"


純粋関数として実装する。

---

## 7.2 タイムゾーン対策

- date型なら単純比較
- timestamptzの場合は日付部分のみ比較
- 日付ズレが発生しないこと

---

## 7.3 適用範囲

- フラット表示のみに適用
- ツリー表示は変更しない

---

# 8. 受け入れ条件

- フラット表示で自動的に上記ソートが適用される
- 期限切れと今日が赤になる
- 今日を除く3日以内が黄色になる
- 期日なしは通常表示
- 並び順と色が直感的に一致する
- リロード後も同一表示になる

---

# 9. 禁止事項

- 文字列比較で日付判定を行うこと
- タイムゾーン無視
- 背景全面塗りによる青との衝突
- フラット表示とツリー表示でソート基準を混在させること

