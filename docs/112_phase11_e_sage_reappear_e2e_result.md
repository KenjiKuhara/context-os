# 112 — Phase11-E 大賢者助言 再出現制御 E2E 結果

Phase11-E（大賢者メッセージの再出現制御）の手動 E2E 確認結果を記録する。

**参照**: [111_phase11_e_sage_reappear_e2e_plan.md](111_phase11_e_sage_reappear_e2e_plan.md)。

---

## 1. 実施日

- **実施日**: 2026-02-08（手動 E2E 実施完了）

---

## 2. 実施環境

| 項目 | 内容 |
|------|------|
| **画面** | /dashboard（大賢者助言ブロックが表示される条件を用意） |
| **ブラウザ** | Chrome（手動確認用） |
| **デプロイ環境** | ローカル開発（localhost） |

---

## 3. 手動 E2E 手順（111 の DoD に基づく）

| # | 確認観点 | 手順 | 結果 | Observed（想定外挙動） |
|---|----------|------|------|------------------------|
| 1 | **同じ kind はクリック後に再表示されない** | 判断待ち 2 件以上で「判断待ち」助言を表示 → 推奨アクション行をクリック → トレーが「判断待ち」に切替わり先頭タスクにフォーカス。リロードせずそのまま（他操作や時間経過のみ）で確認。 | ✅ | クリック直後は助言ブロックが消え、トレー・一覧は判断待ちに絞られたまま。DevTools で `kuharaos.sage.lastHandled` に `{"kind":"needs_decision","timestamp":...}` が保存されていることを確認。同じ条件のまま再取得しても助言は再表示されず、期待どおり同 kind 抑制が効いている。 |
| 2 | **滞留が解消すると lastHandled が削除され再出現が許可される** | 上記のあと、判断待ちを 1 件以下に減らす（状態変更で NEEDS_DECISION を他状態へ移す等）。→ 助言が消え、Application で `kuharaos.sage.lastHandled` が削除されていることを確認。再度判断待ちを 2 件以上に戻す。 | ✅ | いずれの条件も閾値未満になったタイミングで localStorage から lastHandled が removeItem されていることを確認。再度判断待ち 2 件以上にすると「判断待ち」助言が再表示され、再出現が許可されていることを確認。 |
| 3 | **別 kind に切り替わるケース** | 「判断待ち」助言表示中にアクションをクリックして lastHandled を記録。判断待ちを解消し、実施中 60 分以上未更新のタスクのみ残す状態にする。 | ✅ | 候補が needs_decision から in_progress_stale に変わり、「実施中のタスクのうち、60 分以上更新がないものが…」の助言が表示された。lastHandled は needs_decision のままなので、別 kind は抑制されず表示されることを確認。 |
| 4 | **localStorage が空／壊れていても落ちない** | DevTools で `kuharaos.sage.lastHandled` を removeItem。リロード後、滞留条件を満たす状態で /dashboard を表示。続けて不正 JSON（例: `setItem(key, "invalid")`）で上書きし、再リロード・再表示。 | ✅ | removeItem 時は助言が表示され、クリックでトレー切替・フォーカスが動作。不正 JSON 時もコンソールにエラーは出ず、JSON.parse が try-catch で握りつぶされ candidate がそのまま返り助言が表示されることを確認。クリックも問題なく動作。 |
| 5 | **既存のトレー切替・フォーカス・ハイライトが壊れていない** | 助言の推奨アクションをクリックし、該当トレー切替・先頭タスク選択・ツリー時は祖先展開・ハイライトを確認。トレーカード・一覧のノードを直接クリックして従来挙動を確認。 | ✅ | 助言クリックで「判断待ち」「実施中」「その他」それぞれ該当トレーに切替わり、最上位の対象ノードが詳細に表示され、ツリー表示時は祖先が展開され該当行がハイライトされた。トレーカード・一覧クリックでも従来どおり切替・詳細・ハイライトが動作。Phase11-D 導線と整合。 |

---

## 4. 結果

- **結果**: **全て ✅**
- 111 の DoD #1〜#5 を順に実施し、いずれも期待どおり動作した。実装・閾値の変更は行っていない。

---

## 5. 影響なし確認（簡易）

| 項目 | 確認内容 | 結果 |
|------|----------|------|
| **Phase11-D 導線** | 助言の推奨アクションクリックで、該当トレー・最上位対象タスクのフォーカス・ツリー展開・ハイライトが動作する。 | ✅ 壊れていない |
| **通常のトレー・一覧操作** | トレーカードのクリック、一覧のノードクリックで、従来どおりトレー切替・詳細表示・ハイライトが動作する。 | ✅ 壊れていない |

---

以上。Phase11-E 再出現制御の手動 E2E を実施し、結果を記録した。
