# 44 — Phase 5 進路オプション比較

Phase 5 で取り得るルートを並べ、「何を得られるか」「難易度」「リスク」「今やる価値」を比較する。どれを選ばなくても理由が残り、**選べる状態** を作るのが目的。正解を 1 つに決めず、まだ実装はしない。

---

## 1. 前提

- **Phase 4 は完了している**（43_phase4_done_summary.md の範囲）。Organizer / Advisor の提案生成・品質保証・UI 表示・Advisor Apply（status 変更）までが動いている。
- **Phase 5 では「一度に 1 つの主軸しかやらない」** 方針とする。複数ルートを同時に進めず、1 ルートを選んで完了させてから次を検討する。スコープのブレと依存関係の複雑化を避けるため。

---

## 2. ルート A：Organizer Apply（差分反映）

### 何ができるようになるか

- Organizer の提案（分解案・グループ案・関連案）を「見るだけ」から **「採用して DB に反映する」** まで閉じる。
- 例：分解案を採用 → 子 Node が作成される。グループ案を採用 → グループラベルが付与される。関連案を採用 → relation が作成される。
- ユーザーは「提案を選んで Apply」すると、机の上の構造が実際に変わる。

### 必要な設計・実装要素

- **適用対象の明確化**：どの提案タイプ（decomposition / grouping / relation）を、どの API・トランザクションで反映するか。既存の nodes / relations のスキーマと整合させる。
- **確認オブジェクト**：Advisor Apply と同様に「何を適用するか」を明示した confirmation を発行し、1 承認 1 適用にする。confirmations の proposed_change を拡張するか、Organizer 用の別形状を定義するか。
- **UI**：Organizer タブ側に「この案で反映する」のような Apply 入口と、適用対象のプレビュー・confirm ダイアログ。
- **ロールバック・部分失敗**：子 Node を複数作る場合、途中で失敗したときの扱い（全部戻すか、できた分だけ残すか）のポリシー。

### 難易度

**中〜高**。提案の種類ごとに反映ロジックが違い、既存 API（子 Node 作成・relation 作成など）との接続と、confirmation の拡張が必要。トランザクション境界の設計が効く。

### リスク

- 反映内容が LLM 出力に依存するため、validator で Must を満たしていても「意図と違う構造」ができる可能性がある。プレビューを十分に見せる必要がある。
- 一括反映で Node が増えすぎると、dashboard のパフォーマンスや UX に影響する。

### 今やる価値

- Organizer の価値が「提案を見る」から「提案で机の上が変わる」に変わり、**体験のインパクトが大きい**。
- Phase 4 で Advisor Apply のパターン（confirmations → 適用）が固まっているので、同じ考え方で拡張しやすい。一方で、Organizer は「何を適用するか」の形が Advisor より複雑なので、設計に時間がかかる。

---

## 3. ルート B：判断ログ・履歴

### 何ができるようになるか

- 「誰がいつ、どの提案を採用したか」「どの confirmation で何が変わったか」を **一元的に参照・検索できる** 基盤ができる。
- 監査・振り返り・分析（どの案がよく選ばれるか、どの Node で Apply が多いか）に使える。Phase 4 では node_status_history と confirmation_events に情報は残っているが、それを「判断ログ」としてまとめて見る UI や API はない。

### 必要な設計・実装要素

- **データの範囲**：status 変更だけか、将来の Organizer Apply やその他イベントも含めるか。テーブルを増やすか、既存の history / confirmation_events を横断して見る層を作るか。
- **参照 API と UI**：履歴一覧の取得、フィルタ（Node 単位・日時・操作種別）、必要ならエクスポート。
- **個人情報・保持期間**：誰がやったかを残す場合の扱いと、ログの保持ポリシー。

### 難易度

**低〜中**。既存テーブルを読む API と一覧 UI が中心。範囲とスキーマを決めれば実装量は比較的抑えられる。一方で「何をログとするか」の product 判断が効く。

### リスク

- やりすぎると「何でもログ」になり、スキーマやクエリが重くなる。Phase 5 では「判断・Apply に紐づく履歴」に絞るのが無難。
- 監査要件が強い環境では、改ざん防止や保持期間の要件が後から増える可能性がある。

### 今やる価値

- **OS としての信頼性・説明可能性** が上がる。「なぜこの状態になったか」を後から追える基盤になる。
- Organizer Apply（ルート A）をやる前に整えておくと、「何を適用したか」も同じ枠で残せて一貫する。逆に、まずルート A をやり、後から「Apply ログをまとめて見たい」となったときにルート B をやる選択もある。

---

## 4. ルート C：Advisor → 次タスク生成

### 何ができるようになるか

- 「この案で進める」の先に、**選んだ案に応じた子タスク（Node）の自動作成** や、**次の Node への提案フロー** をつなげる。
- 例：案 A「承認する」を選んだ → 「依頼先に連絡する」という子 Node が 1 件できる。案 B「保留する」を選んだ → 「確認事項を送る」Node ができる、など。Phase 4 では「status を変える」までで止まっている部分を延長する。

### 必要な設計・実装要素

- **案と生成内容の対応**：Advisor の option と「何を生成するか」のマッピング。LLM に「この案を選んだときの次のタスク」を出力させるか、ルールベースで固定するか。
- **Node 作成 API との接続**：子 Node 作成や既存の POST /nodes 等を、confirmations と 1 承認 1 適用でどう呼ぶか。
- **UI**：「この案で進める」の先に「次タスクを自動作成しますか？」のような確認を挟むか、Apply と一体化するか。

### 難易度

**中**。Advisor の option は LLM 出力なので、「選んだ案 → 生成する Node の内容」を安定して決める設計（プロンプトで構造化させるか、テンプレートで補うか）が要る。Advisor Apply の延長ではあるが、生成物の品質とスコープの切り方が効く。

### リスク

- 自動生成される Node が「ノイズ」になると、かえって手間が増える。生成するかどうかをユーザーが選べるようにするか、生成内容のプレビューを必ず見せるかなどの UX が重要。
- Advisor の案が増えると、案ごとの「次タスク」定義が複雑になりやすい。最初は 1 案 1 パターンなどに絞ると安全。

### 今やる価値

- **「選んだら次が自動で用意される」** 体験になり、Advisor の価値が一段上がる。
- Phase 4 の Advisor Apply と直列でつながるため、ユーザーストーリーとしては自然。その代わり、Organizer の「机の上の構造化」とは別軸なので、優先度は「Advisor を深掘りするか」「Organizer を完了させるか」の判断に依存する。

---

## 5. 比較表

| 観点 | ルート A（Organizer Apply） | ルート B（判断ログ・履歴） | ルート C（Advisor → 次タスク生成） |
|------|-----------------------------|----------------------------|-------------------------------------|
| **ユーザー体験インパクト** | 大（提案で構造が実際に変わる） | 中（振り返り・説明がしやすくなる） | 大（選んだ案の先にタスクができる） |
| **実装コスト** | 中〜高（反映ロジック・確認オブジェクト・UI） | 低〜中（参照 API・一覧 UI） | 中（案と生成の対応・Node 作成接続） |
| **OS としての重要度** | 高（Organizer が「使える」になる） | 高（説明可能性・監査の基盤） | 中〜高（Advisor の価値向上） |
| **将来拡張との相性** | 他サブエージェントの「提案 → 適用」のひな形になる | どのルートでも「何をしたか」を残す基盤になる | 他の「選択 → 自動生成」フローのひな形になる |

---

## 6. 推奨案

正解を 1 つに絞らない。以下は「選ぶときの目安」として残す。

### 最初にやるなら

- **ルート A（Organizer Apply）** を選ぶ場合：Phase 4 で「Advisor は Apply まで閉じた」のに対し、Organizer はまだ「見るだけ」なので、**両方とも「提案 → 適用」で揃えたい** なら A を先にやる価値が大きい。体験の変化も分かりやすい。
- **ルート B（判断ログ・履歴）** を選ぶ場合：**説明可能性や監査を早めに整えたい** とき。A や C をやる前に「Apply したことを残す・見る」基盤を置いておくと、後から A/C を足したときも同じ枠で履歴を扱える。
- **ルート C（Advisor → 次タスク生成）** を選ぶ場合：**Advisor の利用をさらに深掘りしたい** とき。Phase 4 の Apply の延長で、「選んだ案の先」まで自動化する。Organizer の構造化より「1 Node の意思決定の先」を重視するなら C が合う。

### 後回しでよいもの

- **ルート B** を後回しにする場合：「まずは Apply を増やして価値を見せたい。履歴の一元参照は、Apply が増えてからまとめてやる」という割り切り。その場合、Phase 4 の node_status_history / confirmation_events のままでも運用はできる。
- **ルート C** を後回しにする場合：「Advisor は status 変更までで十分。次タスク生成は、ユーザーが『欲しい』と明示してからやる」という割り切り。Phase 4 の範囲でも Advisor の価値は出ている。
- **ルート A** を後回しにする場合：「Organizer は当面プレビュー止まり。まずは履歴（B）や Advisor 拡張（C）で差別化する」という割り切り。その場合、Organizer は「提案を見て人が手動で反映する」運用のままになる。

### 判断理由を残すためのメモ

- どのルートを選んだか・選ばなかったかは、**この文書と 43 を参照すれば理由が復元できる** ようにした。
- 「今やる価値」と「後回しでよい」は、**リソース・優先機能・リスク許容** によって変わる。ここでは「選べる状態」を作ることに重きを置き、実装は Phase 5 の計画で決める。
