# 20_SubAgent_Catalog.md
## SubAgent カタログ：権限レベル別の分類と設計マップ

---

## 0. この文書の目的

本ドキュメントは、context-os に存在しうるサブエージェントを  
**権限レベル別に分類し、設計の全体像を示す**ためのカタログである。

目的は以下の通り。

- 「どこまで任せてよいか」の判断基準を固定する
- エージェントを追加するときに「どの Level か」を最初に決めさせる
- MCP / 外部接続の安全な制約を定義する

本ドキュメントは以下を前提とする。

- 00_Vision_NorthStar.md §5.4 — AI は管理者、人は最終責任者
- 03_Non_Goals.md §1.3 — AI 秘書にはならない
- 10_Architecture.md §3 — AI に考えさせるが、決めさせない
- 18_Skill_Governance.md — Skill ガバナンス共通ルール
- 19_SubAgent_Observer.md — Level 0 の基準設計

---

## 1. なぜ Level を分けるのか

### 1.1 context-os の原則との関係

context-os は「判断を奪わず、判断を支える」OS である（00_Vision §5.4）。  
しかし「支え方」にはグラデーションがある。

| 支え方 | 例 | 判断への距離 |
|--------|-----|------------|
| 観測する | 「この Node は冷えてきています」 | 遠い（事実の提示） |
| 整理する | 「この 3 件は関連しています」 | やや遠い（構造化） |
| 案を出す | 「こういう次の一手はどうですか」 | 近い（選択肢の構成） |
| 代わりに押す | 人間承認後に Apply ボタンを押す | 最も近い（実行の代行） |

距離が近いほど**「AI が決めた」と人間が感じるリスク**が高い。  
Level はこのリスクに応じて、  
エージェントの権限を構造的に制限するための仕組みである。

### 1.2 Level がない場合に起きること

- エージェントごとに「何ができるか」がバラバラになる
- 新しいエージェントを追加するたびに権限設計を一からやり直す
- MCP 経由で外部 AI をつないだとき、意図しない Apply が発生する
- 「このエージェントは安全か？」の判断が属人化する

Level を先に定義しておくことで、  
**「このエージェントは Level X だから、ここまでしかできない」**  
と一意に決まる。

---

## 2. Level 定義

### 概要

| Level | 名称 | 一言定義 | Apply | 基準エージェント |
|-------|------|---------|-------|-----------------|
| **0** | Observer | 観測し、提案する | **禁止** | Observer（19） |
| **1** | Organizer | 整理し、構造化する | **禁止** | — |
| **2** | Advisor | 下書き・代替案を生成する | **禁止** | — |
| **3** | Executor | 人間承認後に Apply を代行する | **条件付き許可** | — |

**重要：Level 0〜2 は Apply 禁止が共通。**  
Level 3 のみが、厳格な条件下で Apply を実行できる。

---

## 3. Level 0：Observer（観測・提案）

### 3.1 基準設計

`19_SubAgent_Observer.md` が Level 0 の完全な設計書である。  
本カタログでは Level 間の比較に必要な要点のみ記載する。

### 3.2 特性

| 項目 | 内容 |
|------|------|
| **役割** | Node の状態を観測し、人間が再開判断しやすい提案を構成する |
| **Skill 利用** | Preview / 読み取り **のみ** |
| **Apply** | **禁止** |
| **DB 書き込み** | **禁止** |
| **出力** | 提案（ObserverReport）のみ。確定フィールドなし |
| **判断への距離** | 最も遠い（事実と推定の提示） |

### 3.3 適用される 18_Skill_Governance ルール

- §2.1 Preview は無制限 → Observer の全操作がここに収まる
- §2.2 Apply は人間確認必須 → Observer は Apply を呼ばないのでそもそも該当しない
- §4.1 Preview 連鎖は許可 → Observer は複数 Skill の Preview を組み合わせてよい

### 3.4 代表的なエージェント候補

| エージェント名 | 役割 |
|---------------|------|
| **Observer**（19） | status / temperature の観測、冷却検知、「今なにやる？」の材料構成 |
| **Watcher**（将来） | 外部イベント（メール / ChatWork / カレンダー）を監視し、再燃トリガーを検知 |

---

## 4. Level 1：Organizer（整理・構造化）

### 4.1 Observer（Level 0）と何が違うか

Observer は「見たものをそのまま報告する」。  
Organizer は「見たものを整理し、構造を提案する」。

| | Level 0 (Observer) | Level 1 (Organizer) |
|---|-------------------|---------------------|
| 入力 | Node の現在状態 | Node 群の関係・文脈 |
| 処理 | 観測 + 推定候補の取得 | 関連づけ + 分類 + 要約 |
| 出力 | 個別 Node ごとの提案 | Node 群の構造的整理 |
| 人間に伝えるもの | 「これが冷えています」 | 「この 3 件はまとめられます」 |

### 4.2 特性

| 項目 | 内容 |
|------|------|
| **役割** | Node 群の関連を分析し、整理・要約・再分類を提案する |
| **Skill 利用** | Preview / 読み取り **のみ**（Observer と同じ） |
| **Apply** | **禁止** |
| **DB 書き込み** | **禁止** |
| **出力** | 構造化された提案（グルーピング案 / 要約文 / 関連提案） |
| **判断への距離** | やや遠い（構造化の提示） |

### 4.3 適用される 18_Skill_Governance ルール

Observer と同一。Level 0 の全ルールがそのまま適用される。

- §2.1 Preview は無制限
- §2.2 Apply は人間確認必須（Organizer は Apply しない）
- §4.1 Preview 連鎖は許可

### 4.4 代表的なエージェント候補

| エージェント名 | 役割 |
|---------------|------|
| **Summarizer**（将来） | 複数 Node を横断して「全体の状況」を要約する |
| **Grouper**（将来） | 関連する Node を検出し、グループ化を提案する |
| **Decomposer**（将来） | 大きな Node の分解案を構成する（子 Node 作成自体はしない） |

### 4.5 Organizer が「やらないこと」

- Node の作成・削除・更新（構造変更の提案はするが、実行はしない）
- 子 Node の自動作成（`POST /nodes/{id}/children` は呼ばない）
- 参照関係（relations）の自動追加

---

## 5. Level 2：Advisor（下書き・代替案生成）

### 5.1 Organizer（Level 1）と何が違うか

Organizer は「既存の情報を整理する」。  
Advisor は「新しい情報（文案・選択肢・シナリオ）を生成する」。

| | Level 1 (Organizer) | Level 2 (Advisor) |
|---|---------------------|-------------------|
| 入力 | Node 群の関係 | Node の context + 人間の意図 |
| 処理 | 分類 + 要約 | 文案生成 + 選択肢構成 |
| 出力 | 構造の提案 | 下書き・判断の選択肢 |
| 人間に伝えるもの | 「こう整理できます」 | 「こういう案はどうですか」 |

### 5.2 特性

| 項目 | 内容 |
|------|------|
| **役割** | 人間の判断を支援するための文案・代替案・シナリオを生成する |
| **Skill 利用** | Preview / 読み取り **のみ**（Level 0/1 と同じ） |
| **Apply** | **禁止** |
| **DB 書き込み** | **禁止** |
| **出力** | 下書きテキスト / 選択肢リスト / 判断の整理 |
| **判断への距離** | 近い（選択肢の構成） |

### 5.3 適用される 18_Skill_Governance ルール

Level 0/1 と同一。Apply 禁止は不変。

### 5.4 Level 2 特有の注意点

Advisor は「判断に近い」出力を生成するため、  
以下のリスクがある。

| リスク | 対策 |
|--------|------|
| AI の案を「そのまま採用」してしまう | 出力に必ず複数案を含める。単一案の提示は避ける |
| 下書きが「確定」と混同される | 出力のラベルを「案」「下書き」と明示する |
| 判断の主導権が AI に移る | 最終判断は人間 UI で行う構造を維持する |

03_Non_Goals.md §1.3「判断を代行して決める」に特に注意する。

### 5.5 代表的なエージェント候補

| エージェント名 | 役割 |
|---------------|------|
| **DecisionHelper**（将来） | NEEDS_DECISION の Node に対して選択肢と判断観点を整理する（09 §12 decision-support 対応） |
| **DraftWriter**（将来） | Node の context から次のアクションの下書き文を生成する |
| **ScenarioBuilder**（将来） | 複数の分岐シナリオを提示し、判断材料を構成する |

---

## 6. Level 3：Executor（承認後の Apply 代行）

### 6.1 Level 2 以下と何が違うか

Level 0〜2 は Apply を**一切呼べない**。  
Level 3 は、**人間が承認した後に限り**、Apply を代行できる唯一の Level である。

| | Level 0〜2 | Level 3 (Executor) |
|---|-----------|-------------------|
| Apply | 禁止 | 人間承認後に限り許可 |
| DB 書き込み | 禁止 | Skill 経由でのみ可 |
| 判断 | しない | しない（実行のみ） |
| 責任 | なし | 人間の承認を受けた範囲に限定 |

### 6.2 特性

| 項目 | 内容 |
|------|------|
| **役割** | 人間が承認した提案を、Skill の Apply として実行する |
| **Skill 利用** | Preview + **Apply（人間承認後のみ）** |
| **Apply** | **条件付き許可**（18 §3 の source + confirmation 必須） |
| **DB 書き込み** | Skill 経由でのみ（直接書き込みは禁止） |
| **出力** | Apply の実行結果 |
| **判断への距離** | 最も近い（実行の代行） |

### 6.3 適用される 18_Skill_Governance ルール

| ルール | 適用 |
|--------|------|
| §2.2 Apply は人間確認必須 | **厳格に適用**。confirmation.confirmed_by === "human" が必須 |
| §3 source + confirmation | source = "ai_agent"、confirmation 必須 |
| §4.2 Apply 連鎖は禁止 | Executor は Apply を 1 つだけ実行する。連鎖しない |
| 17 §10.2 (1) 遷移拒否時の再提案義務 | 422 が返った場合、Executor は自動リトライせず人間に返す |
| 17 §10.2 (3) DONE/CANCELLED は人間確認必須 | Executor でも例外なし |

### 6.4 Executor の構造的制約

Executor が安全である理由は以下の 3 つの制約による。

**制約 1：Executor は判断しない**

Executor は「何を Apply するか」を自分で決めない。  
人間が承認した `{ node_id, confirm_status, reason }` を  
そのまま Skill に渡すだけである。  
Executor が Apply の内容を改変することは禁止する。

**制約 2：承認は 1 回 1 Apply**

人間の承認 1 件につき、Executor は Apply を 1 回だけ実行する。  
「まとめて 5 件承認 → 5 件一括 Apply」は許可するが、  
「1 件承認 → 関連する 3 件も自動で Apply」は禁止する。  
（18 §4.2 Apply 連鎖禁止）

**制約 3：結果は必ず人間に返す**

Executor は Apply の結果（成功 / 失敗 / 422 拒否）を  
必ず人間に報告する。  
結果を握りつぶしたり、失敗を自動リトライしたりしない。

### 6.5 代表的なエージェント候補

| エージェント名 | 役割 |
|---------------|------|
| **ApplyAgent**（将来） | 人間が承認した status 変更を estimate-status Apply として実行する |
| **BatchApplier**（将来） | 人間が一括承認した複数件の Apply を順次実行する |

### 6.6 Executor 設計時の判断基準

Level 3 を設計する前に、必ず以下を確認する。

> **「Executor なしで、人間が直接 Apply を呼べるか？」**

- Yes → Executor は不要。人間 UI で十分。
- No → なぜ人間が直接呼べないのかを明確にする（一括処理等）。

> **「Executor が判断を含んでいないか？」**

- 含んでいる → Level 3 ではない。Level 0〜2 に分解する。
- 含んでいない → Executor として設計してよい。

---

## 7. Level と Skill の対応マトリクス

| Skill 操作 | Level 0 | Level 1 | Level 2 | Level 3 |
|-----------|---------|---------|---------|---------|
| estimate-status **Preview** | OK | OK | OK | OK |
| estimate-status **Apply** | **禁止** | **禁止** | **禁止** | **承認後のみ** |
| GET /dashboard/active | OK | OK | OK | OK |
| GET /dashboard/cooling | OK | OK | OK | OK |
| GET /nodes/{id} | OK | OK | OK | OK |
| POST /nodes | 禁止 | 禁止 | 禁止 | 禁止 |
| PATCH /nodes/{id} | 禁止 | 禁止 | 禁止 | 禁止 |
| POST /nodes/{id}/children | 禁止 | 禁止 | 禁止 | 禁止 |
| POST /resume/next | OK | OK | OK | OK |
| DB 直接操作 | 禁止 | 禁止 | 禁止 | 禁止 |

**注意**：POST /nodes（Node 作成）と PATCH /nodes/{id}（Node 更新）は  
どの Level のサブエージェントにも許可しない。  
Node の作成・更新は人間の入力（Capture / context 修正）または  
専用の Skill（将来定義）を経由する。

---

## 8. MCP / 外部 Agent の接続ルール

### 8.1 MCP は Level 0 として接続する（MVP）

MCP は 10_Architecture §2.3「LLM から外部世界への手」であり、  
LLM の指示を Skill に中継する役割を持つ。

MVP では MCP を **Level 0 相当** として扱い、  
**Preview / 読み取りのみ**を許可する。

理由：
- MCP の背後にいる LLM が「どこまで判断したか」を検証できない
- 18 §3 の confirmation を MCP 経由で安全に渡す仕組みが未整備
- 03_Non_Goals §2.1「勝手なステータス確定」を構造的に防ぐ

### 8.2 外部 Agent は Level 0 でのみ接続可能（MVP）

外部 AI サービス（ChatGPT Plugin、他社 Agent 等）を  
context-os に接続する場合、**Level 0 のみ**を許可する。

理由：
- 外部 Agent の内部ロジックを context-os 側で検証できない
- 「考えさせるが、決めさせない」を外部 Agent に強制できるのは  
  Preview 限定という構造的ガードのみ
- Level 1〜2 は入出力の型が複雑になり、外部 Agent が誤用するリスクがある

### 8.3 Level 3 への昇格条件（将来）

MCP / 外部 Agent を Level 3 に昇格させる場合、  
以下のすべてが満たされる必要がある。

1. **source フィールドが実装済み**であること
2. **confirmation の検証**が Skill 側で行われること
3. **人間の承認フロー**が UI に実装されていること  
   （Agent の提案を一覧表示 → 承認ボタン → Agent が Apply）
4. **監査ログ**（history + source + confirmed_by）が記録されること

これらが揃わない限り、  
MCP / 外部 Agent は Level 0 に留める。

---

## 9. Level の選び方ガイド

新しいサブエージェントを設計するとき、  
以下のフローで Level を決定する。

```
Q1: このエージェントは Apply（状態確定）を行うか？
  │
  ├─ No ──→ Q2 へ
  │
  └─ Yes ─→ Q3: 人間の承認後に実行するだけか？
               │
               ├─ Yes ─→ Level 3（Executor）
               │
               └─ No ──→ 設計を見直す。
                          Apply の判断をエージェントがしている。
                          判断部分を Level 0〜2 に分離し、
                          Apply 部分だけを Level 3 にする。

Q2: このエージェントは新しい情報（文案・選択肢）を生成するか？
  │
  ├─ No ──→ Q4 へ
  │
  └─ Yes ─→ Level 2（Advisor）

Q4: このエージェントは既存情報を整理・構造化するか？
  │
  ├─ No ──→ Level 0（Observer）
  │
  └─ Yes ─→ Level 1（Organizer）
```

**迷ったら Level 0 にする。**  
権限は後から上げられるが、下げるのは難しい。

---

## 10. この文書の位置づけ

本ドキュメントは、

- サブエージェント新規設計時の **Level 判定ガイド**
- MCP / 外部 Agent 接続時の **権限上限の定義**
- 18_Skill_Governance.md の **具体的な適用マップ**
- 19_SubAgent_Observer.md を基準とした **比較・拡張の起点**

として機能する。

Level に迷った場合は、  
**「このエージェントが暴走したとき、何が起きるか？」**  
を想像し、被害が最小になる Level を選ぶ。
