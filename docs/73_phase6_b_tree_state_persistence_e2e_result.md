# 73 — Phase6-B ツリー開閉状態の永続化 E2E 結果

**本ドキュメントは Phase6-B MVP（ツリー開閉状態の永続化）の手動確認証跡である。** 72_phase6_b_tree_state_persistence_plan.md の Definition of Done に沿って実施した結果を記録する。

**参照**: 72_phase6_b_tree_state_persistence_plan.md、68_phase6_a_tree_ui_mvp.md。

---

## 1. 実施日

- **実施日**: 2026年2月8日

---

## 2. 実施環境

| 項目 | 内容 |
|------|------|
| **フロント** | localhost（Next.js 開発サーバー） |
| **ブラウザ** | 手元のブラウザ（Chrome / Edge / Firefox 等） |
| **実施方法** | /dashboard を開き、ツリー表示で開閉操作 → リロードまたは別タブ往復 → 復元を目視確認。localStorage は DevTools の Application タブで確認。 |

---

## 3. 実施した手動確認手順（72 の DoD 対応）

1. /dashboard を開き、一覧を「ツリー」表示にする。
2. 子を持つノードを複数、▶ をクリックして開く。
3. ページをリロード（F5）する。再表示後、開いていたノードが開いたままになっていることを確認する。
4. 一部のノードを閉じる。再度リロードし、閉じた状態が維持されていることを確認する。
5. 別タブで /dashboard を開く、または一度他ページへ遷移してから /dashboard に戻る。開閉状態が復元されていることを確認する。
6. 開閉を変更したあと、DevTools → Application → Local Storage で該当キーに配列が保存されていることを確認する。
7. （任意）localStorage に存在しないノード ID を手動で追加した場合、リロード時にエラーにならず存在する ID だけが展開されることを確認する。
8. フラット／ツリー切替、キーボード（→←↑↓）、右側詳細パネルの選択が従来どおり動作することを確認する。

---

## 4. 各チェック項目の結果

| # | 条件（72 DoD 相当） | 結果 |
|---|---------------------|------|
| 1 | ツリーでいくつかノードを開き、F5 リロード後も開いたままになっている | OK |
| 2 | ツリーでノードを閉じ、リロード後も閉じた状態が維持されている | OK |
| 3 | 別タブまたは再遷移で /dashboard に戻ったとき、開閉状態が復元されている | OK |
| 4 | 開閉変更後、localStorage にキーで配列が保存されていることを DevTools で確認できる | OK |
| 5 | 存在しないノード ID が含まれていても読み込み時にエラーにならず、存在する ID だけが展開される | OK |
| 6 | Phase6-A の挙動が壊れていない（フラット／ツリー切替、キーボード、詳細パネル連携） | OK |

---

## 5. 確認証跡

### 5.1 localStorage のキー名

- **キー名**: `kuharaos.tree.expanded.v1`

### 5.2 保存されている値の例

- **形式**: JSON 配列（ノード ID の文字列のリスト）。
- **例**: `["xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx","yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy"]`  
  （実際の UUID は伏字ではなくそのまま保存されている。証跡として必要なら一部を xxx 等に置換して記録してよい。）

---

## 6. 備考

- **フラットモードでは対象外であること**: 一覧を「フラット」表示にしている間は、開閉状態の保存・復元は行わない。ツリー表示に切り替えた時点で、前回ツリー表示時に保存した内容が復元される。
- **存在しない node_id は無視されること**: 復元時に localStorage から読み取った ID のうち、現在のツリー（visibleNodes）に存在する ID だけを expandedSet に反映する。削除済みノードの ID 等は無視され、エラーにはならない。

---

以上をもって、**Phase6-B ツリー開閉状態の永続化** の手動 E2E 結果とする。
