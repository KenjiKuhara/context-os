# 117 — ダークモード設計（戦略・設計・MVP）

Phase11-B クローズ後、ダークモードを「戦略 → 設計 → 実装」の順で導入する。衝動実装は行わず、本ドキュメントで方式・UI 前提・MVP を固定してから着手する。

**前提**: Phase11-B で統一した表示文言（タスク・状態・観測結果 等）を壊さない。表示層の色・テーマのみを対象とする。

---

## 1. 導入方式の 3 案比較と採用案

| 観点 | 案 A: 常時ダーク固定 | 案 B: ライト/ダーク切替（トグル） | 案 C: OS 追従（prefers-color-scheme）＋手動切替 |
|------|----------------------|-----------------------------------|--------------------------------------------------|
| **実装コスト** | 低（テーマ 1 種のみ） | 中（トグル UI・永続化） | 中〜高（メディアクエリ＋上書き用切替・永続化） |
| **ユーザー選択** | なし。常にダーク | 明示的にトグルで切り替え | 初期は OS に合わせつつ、手動で上書き可能 |
| **アクセシビリティ** | ダークが苦手なユーザーに不向き | どちらも選べる | OS 設定を尊重しつつ個別調整可 |
| **一貫性** | 常に同じ見た目 | 選択に応じて変わる | 環境＋設定で変わる |
| **将来拡張** | ライトを追加するなら実質 B に | そのまま。OS 連携を足すなら C に | そのまま |

### 採用案（断定）

**案 C: OS 設定に追従（prefers-color-scheme）＋手動切替** を採用する。

- **理由**: 多くの OS がライト/ダークをシステム設定で提供しており、その尊重は期待に沿う。一方で「今だけライトで見たい」「常にダークにしたい」という要望には手動切替で対応できる。
- **実装イメージ**: 初期値は `prefers-color-scheme: dark` 等で判定。ユーザーが画面上で「ライト/ダーク/システムに合わせる」のいずれかを選べるようにし、選択を localStorage 等で永続化。システムに合わせる場合はメディアクエリの変更をそのまま反映する。

---

## 2. UI 設計の前提（ドキュメント化）

以下はトークではなく、設計判断として docs に起こす。

### 2.1 色トークン方針

- **方式**: CSS 変数（Custom Properties）を採用する。Tailwind 未使用のため、`:root` および `[data-theme="dark"]`（または `[data-theme="light"]`）でセマンティックなトークンを定義する。
- **トークン例**: 
  - 背景: `--bg-page`, `--bg-panel`, `--bg-card`
  - 文字: `--text-primary`, `--text-secondary`, `--text-muted`
  - 枠線: `--border-default`, `--border-focus`
  - 状態色: `--color-success`, `--color-warning`, `--color-danger`, `--color-info`（§2.3 で扱う）

### 2.2 コントラスト基準（可読性）

- **WCAG 2.1**: 本文は少なくとも AA（コントラスト比 4.5:1 以上）を満たす。重要な UI ラベルも同様。
- **ダークモード**: 背景を暗くする場合、文字は明るい色にし、コントラスト比を維持する。単純な色反転では不十分な場合があるため、状態色（成功/警告/危険）はダーク用に調整した値を使う。

### 2.3 状態色（成功/警告/危険/注目）の扱い

- **成功**: 反映完了・適用済み等。緑系。ライト・ダーク両方で視認性を確保する。
- **警告**: 要確認・少し古い提案等。黄〜オレンジ系。背景が暗いときは彩度・明度を調整する。
- **危険**: エラー・対象なし・異常検知等。赤系。同様にダークで見えすぎ/にじみに注意する。
- **注目**: 選択中・フォーカス・プライマリアクション。既存の青系（#5567ff 等）をトークン化し、ダーク時はやや明るめにしてもよい。

### 2.4 「大賢者助言」と「異常検知」の視認性優先順位

- **大賢者助言（Phase11-D/11-E）**: 滞留検知時のみ表示。推奨アクションをクリック可能にするため、ブロック全体の視認性を最優先する。背景・枠・文字のコントラストを落とさない。
- **異常検知（Observer の ⚠ ブロック）**: 警告として目立たせつつ、長時間見ていても疲れない程度のトーンにする。ダーク時は `#b8860b` 系をやや明るくしたトークンを使う想定。

### 2.5 既存コンポーネントへの影響範囲

| コンポーネント/画面 | 影響内容 |
|---------------------|----------|
| **page.tsx（ダッシュボード）** | トレー・一覧・詳細・推定フロー・大賢者ブロック・Observer ブロックの背景・文字・枠線をトークン参照に置き換える。インライン style の色を段階的にトークンへ移行。 |
| **ProposalPanel.tsx** | パネル背景・カード・ボタン・履歴リスト・状態変更 UI の色をトークン参照に。 |
| **TreeList.tsx** | 行背景・選択/ハイライト色・枠線をトークン参照に。 |
| **StatusBadge** | 背景・文字色をトークン化。状態による色分けがある場合はそのままトークンで切り替え。 |

- **文言**: 一切変更しない。Phase11-B で確定した「タスク」「状態」「観測結果」等はそのまま。

---

## 3. 最小実装の範囲（MVP）

### 3.1 スコープ

- **MVP 第 1 段階**: **/dashboard のみ** をダークモード対応とする。
  - page.tsx およびそこで使う ProposalPanel / TreeList / StatusBadge 等の表示を、CSS 変数（テーマ）で切り替え可能にする。
  - テーマ切替 UI（ライト/ダーク/システムに合わせる）はダッシュボード上に 1 か所設ける。
- **第 2 段階**: 他ルート（存在する場合）や layout 全体へテーマを展開する。localStorage 等で保存したテーマ設定をアプリ全体で共有する。

### 3.2 既存文言統一を壊さないこと

- 色・背景・枠線・フォントサイズのみを変更する。ラベル・メッセージ・aria-label 等の文言は Phase11-B のまま変更しない。
- 新規追加する UI（テーマ切替ボタンやドロップダウン）のラベルのみ、必要に応じて「ライト」「ダーク」「システムに合わせる」等を定義する。

---

## 4. 設計項目一覧（117 のアウトライン）

1. **導入方式の 3 案比較と採用案**（§1）  
   - 常時ダーク / ライト・ダーク切替 / OS 追従＋手動切替 → **採用: 案 C**

2. **色トークン方針**（§2.1）  
   - CSS 変数（セマンティックトークン）。`:root` と `[data-theme="dark"]`（または light）で定義。

3. **コントラスト基準**（§2.2）  
   - WCAG 2.1 AA 以上。ダーク時は明度・彩度を調整。

4. **状態色の扱い**（§2.3）  
   - 成功/警告/危険/注目をトークン化し、ライト・ダーク両方で視認性を確保。

5. **大賢者助言・異常検知の視認性**（§2.4）  
   - 大賢者ブロックと Observer 警告ブロックの優先順位を明記。ダーク時もコントラストを落とさない。

6. **既存コンポーネントへの影響範囲**（§2.5）  
   - page.tsx / ProposalPanel / TreeList / StatusBadge の影響内容を一覧化。

7. **MVP 範囲**（§3）  
   - 第 1 段階: /dashboard のみ。第 2 段階: 全体展開。文言は変更しない。

---

以上。ダークモードは本ドキュメント（117）の方式・前提・MVP に基づき実装する。実装前に本ドキュメントの追記・更新で細部を固める。
