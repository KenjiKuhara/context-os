# 05_State_Machine.md  
## State Machine Specification for context-os

---

## 0. この文書の役割

本ドキュメントは、context-osにおける  
**「状態（Status）」の定義・意味・遷移ルール**を定めるものである。

- 状態は UI のためのラベルではない
- 状態は **思考・作業の局面**を表す
- 状態管理は AI が主に行い、人は例外的に修正する

本ドキュメントは以下を前提とする。

- `00_Vision_NorthStar.md`
- `01_PRD.md`

---

## 1. ステータス設計の基本原則

### 1.1 状態は「汎用」である
- 業務固有（講演専用・営業専用など）の状態は作らない
- すべてのノードに共通して適用できる状態のみを定義する

### 1.2 状態は「作業のライフサイクル」を表す
状態は以下の観点で設計される。

- まだ動いていない
- 動いている
- 止まっている（理由がある）
- 冷えている
- 終わった／やらないと決めた

### 1.3 状態と温度は混ぜない
- **Status**：作業の局面
- **Temperature**：関心・接触頻度・熱量

放置・冷却・再燃は温度で扱い、  
状態は「今どんな局面か」だけを表す。

---

## 2. ステータス一覧（全15種）

### A. 入口（発生〜整理）

#### 1. CAPTURED（捕捉）
- とりあえず拾った状態
- メモ、愚痴、思いつき、雑な入力
- まだ「何をするか」決まっていない

**AI判定の手がかり**
- 入力直後
- 行動やゴールが定義されていない

---

#### 2. CLARIFYING（言語化中）
- 「結局なにをする？」を詰めている段階
- 質問や未確定要素が残っている

**AI判定の手がかり**
- 疑問文が多い
- 次アクションが定義できない

---

#### 3. READY（着手可能）
- 次にやる一手が明確
- いつでも動ける状態

**AI判定の手がかり**
- 明確な next_action が存在
- 依存関係がない

---

### B. 進行（実作業）

#### 4. IN_PROGRESS（実施中）
- 現在進めている
- 手を動かしている状態

**AI判定の手がかり**
- 最近更新されている
- 作業ログ・編集履歴がある

---

#### 5. DELEGATED（委任中）
- 自分以外（人またはAI）に作業を委ねている
- 結果待ちだが責任は自分にある

**AI判定の手がかり**
- 「依頼」「お願い」「任せる」といった文脈
- 実行主体が自分ではない

---

#### 6. WAITING_EXTERNAL（外部待ち）
- 相手の返信・承認・資料待ち
- 自分では進められない理由が明確

**AI判定の手がかり**
- 最後の発言が相手への依頼
- 一定期間、外部からの反応待ち

---

#### 7. SCHEDULED（予約済み）
- 実行日時が決まっている
- その時点まで待つのが正しい状態

**AI判定の手がかり**
- 日時・イベントが紐づいている
- 「◯日にやる」「会議で確認」など

---

### C. 停滞（止まっている理由がある）

#### 8. BLOCKED（障害あり）
- 進めたいが進められない
- 情報・権限・環境が不足している

**AI判定の手がかり**
- 「できない」「足りない」「待ち」が原因として明示されている

---

#### 9. NEEDS_DECISION（意思決定待ち）
- 情報は揃っている
- 判断・選択が必要

**AI判定の手がかり**
- 選択肢が複数存在
- 判断しないと進まない

---

#### 10. NEEDS_REVIEW（見直し待ち）
- 一度作ったが確認・品質チェックが必要

**AI判定の手がかり**
- 「確認」「レビュー」「見直し」が明示されている

---

### D. 冷却・再燃

#### 11. COOLING（冷却中）
- 最近触っていない
- 温度が下がってきている

**AI判定の手がかり**
- 最終更新から一定期間経過
- 期限はまだ先、または存在しない

---

#### 12. DORMANT（休眠）
- しばらく触れていない
- 消すほどではないが、棚の奥にある状態

**AI判定の手がかり**
- 長期間更新なし
- 再開のトリガーが存在しない

---

#### 13. REACTIVATED（再浮上）
- 休眠していたものが再び動き出した

**注意**
- 本来は「イベント」に近いが、
  実装上は一時的な状態として扱う

**AI判定の手がかり**
- 外部イベント
- 関連ノードの更新
- ユーザーの再言及

---

### E. 終了

#### 14. DONE（完了）
- 目的達成
- これ以上やることがない

**AI判定の手がかり**
- ゴール条件が満たされた

---

#### 15. CANCELLED（中止／不要）
- やらないと決めた
- 価値がなくなった、または優先外

**AI判定の手がかり**
- 明示的な中止宣言
- 再開不要と判断できる文脈

---

## 3. 基本的な遷移ルール（概要）

- CAPTURED → CLARIFYING → READY
- READY → IN_PROGRESS
- IN_PROGRESS → DONE / NEEDS_REVIEW / BLOCKED
- 任意 → DELEGATED / WAITING_EXTERNAL
- 任意 → COOLING → DORMANT
- DORMANT → REACTIVATED → READY / IN_PROGRESS
- 任意 → CANCELLED

※詳細な遷移制御は実装に委ねるが、  
本定義から逸脱してはならない。

**「任意」の定義**

上記の「任意 → X」における「任意」は、  
**DONE と CANCELLED を除く全状態**を指す。

- DONE / CANCELLED は**終了状態**である
- 終了状態からの遷移先は **REACTIVATED（再浮上）のみ**許可する
- REACTIVATED は一時的な状態であり、  
  そこから READY / IN_PROGRESS / CLARIFYING 等に再遷移する

この定義により、  
「完了したものが勝手に別の状態に動く」ことを防ぎつつ、  
「やっぱり再開したい」という人間の判断には対応できる。

---

## 4. 人とAIの役割分担

- AIは状態を推定し、更新する
- 人は違和感があれば修正できる
- 人が毎回選ぶ前提では設計しない

---

## 5. このステートマシンの目的

このステートマシンの目的は、

- 正確な管理  
ではなく  
- **再開できること**

である。

状態は「制御」のためではなく、  
**「思考を再び動かす入口」**として存在する。

---

## 6. 本ドキュメントの位置づけ

本ドキュメントは、

- 実装
- プロンプト設計
- AIエージェントの判断

すべてにおいて  
**単一の正解（Single Source of Truth）**となる。

以後、状態に関する議論は  
必ず本ドキュメントを参照する。

**実装上の Single Source of Truth**

コード上の状態定義は `src/lib/stateMachine.ts` に集約する。

- 全15状態の名称と型
- 日本語ラベル
- 遷移マップ（from → to[]）
- バリデーション関数

これらはすべて `stateMachine.ts` から export し、  
API / UI は **import して使用する**。

各ファイルに独自の状態定義やラベルのコピーを持たない。  
状態に関する変更が発生した場合、  
`stateMachine.ts` のみを更新すれば全体に反映される設計とする。


