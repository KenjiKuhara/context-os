# 22_SubAgent_Advisor.md
## SubAgent 設計：Advisor（案出し・選択肢提示エージェント）

---

## 0. この文書の目的

本ドキュメントは、context-os における Level 2 サブエージェントの  
代表例である **Advisor** の役割・制約・Skill 利用ルールを定義する。

Advisor は **「案を出すが、選ばない」** エージェントである。

Observer（19, Level 0）が「事実と推定を報告する」、  
Organizer（21, Level 1）が「構造を整理する」のに対し、  
Advisor は「**人間がまだ持っていない選択肢・文案・シナリオを新たに生成する**」。

Advisor はすべての Level の中で**判断に最も近い**出力を生成する。  
そのため、出力が「正解」に見えすぎないための構造的ガードが最も厳格である。

本ドキュメントは以下を前提とする。

- 00_Vision_NorthStar.md §5.4 — AI は管理者、人は最終責任者
- 03_Non_Goals.md §1.3 — 判断を代行して決めない
- 05_State_Machine.md §2 — NEEDS_DECISION の定義
- 09_API_Contract.md §12 — decision-support API（将来）
- 14_Prompt_Pack.md §9 — 判断支援（Decision Support）Prompt
- 18_Skill_Governance.md — Skill ガバナンス共通ルール
- 19_SubAgent_Observer.md — Level 0 の基準設計
- 20_SubAgent_Catalog.md §5 — Level 2 の定義
- 21_SubAgent_Organizer.md — Level 1 の基準設計

---

## 1. Advisor とは何か

### 1.1 一言での定義

Advisor は、  
**人間が判断に必要な選択肢・文案・シナリオを新たに生成し、  
判断の材料として複数案を提示する**  
サブエージェントである。

### 1.2 Advisor がやること

- NEEDS_DECISION 状態の Node に対して**選択肢と判断観点**を構成する
- 思考が止まっている Node に対して**次の一手の候補**を複数生成する
- Node の context から**下書き文案**を複数パターン生成する
- 人間が比較検討できるよう、**案ごとのメリット・デメリット**を整理する

### 1.3 Advisor が絶対にやらないこと

- **Apply を呼ばない**（status を確定しない）
- **単一の「正解」を提示しない**（必ず複数案を出す）
- **「こうすべき」と結論づけない**（判断の材料を出すだけ）
- **人間の選択を省略する UI を提供しない**（「おすすめ」の自動適用は禁止）
- Node を作成・更新・削除しない
- DB に直接書き込まない

### 1.4 Level 0 / Level 1 との違い

| 観点 | Observer (L0) | Organizer (L1) | Advisor (L2) |
|------|--------------|-----------------|-------------|
| **対象** | 個々の Node の状態 | Node 群の構造 | Node の判断・次の一手 |
| **処理** | 観測 + 推定取得 | 関連検出 + 構造化 | 選択肢生成 + 評価軸整理 |
| **出力の性質** | 事実の報告 | 構造の提案 | **新しい選択肢の創出** |
| **人間に伝えるもの** | 「これが冷えています」 | 「こう整理できそうです」 | 「こういう案が考えられます」 |
| **判断への距離** | 最も遠い | やや遠い | **最も近い** |
| **「正解」に見えるリスク** | 低い | 中程度 | **高い** |

**要約**：  
Observer は「見る」。Organizer は「並べる」。Advisor は「描く」。  
Advisor だけが**存在しなかった情報を新たに作り出す**。

---

## 2. 18_Skill_Governance.md / 20_SubAgent_Catalog.md との対応

### 2.1 ガバナンスルール対応

Advisor は 18_Skill_Governance.md のルールに**完全に従う**。  
Level 0/1 と適用されるルールは同一だが、  
「判断に近い」出力に対する追加ガードを持つ。

| ガバナンスルール | Advisor の振る舞い |
|----------------|-------------------|
| §2.1 Preview は無制限 | Advisor は Skill の Preview / 読み取りのみ使用する |
| §2.2 Apply は人間確認必須 | Advisor は Apply を**一切呼ばない** |
| §3 source + confirmation | Advisor は Apply しないため該当しない |
| §4.1 Preview 連鎖は許可 | Advisor は複数 Skill の Preview を組み合わせてよい |
| §4.2 Apply 連鎖は禁止 | Advisor は Skill の Apply を連鎖呼び出ししない |
| §4.3 提案の返却 | Advisor の出力は常に「人間への複数案提示」である |

### 2.2 カタログ上の位置

20_SubAgent_Catalog.md §5 で定義された Level 2 の代表例。

| 項目 | 20 §5 の定義 | Advisor の実装 |
|------|------------|--------------|
| 役割 | 人間の判断を支援するための文案・代替案・シナリオを生成する | 同左 |
| Skill 利用 | Preview / 読み取りのみ | 同左 |
| Apply | 禁止 | 禁止 |
| 判断への距離 | 近い（選択肢の構成） | 同左 |

### 2.3 20 §5.4 のリスク対策の具体化

20_SubAgent_Catalog.md §5.4 は Level 2 特有のリスクを 3 つ挙げている。  
本ドキュメントではこれらを具体的なルールとして展開する。

| 20 §5.4 のリスク | 本 doc での対策 |
|----------------|---------------|
| AI の案を「そのまま採用」してしまう | §5.3 複数案必須ルール |
| 下書きが「確定」と混同される | §5.4 出力ラベルルール |
| 判断の主導権が AI に移る | §8 構造的ガード（5 層） |

---

## 3. 呼び出してよい Skill

### 3.1 許可される Skill 呼び出し

| Skill | モード | 用途 |
|-------|--------|------|
| `estimate-status` | **Preview のみ** | 対象 Node の遷移候補を確認し、選択肢構成の材料にする |
| `GET /dashboard/active` | 読み取り | アクティブ Node の一覧取得 |
| `GET /dashboard/cooling` | 読み取り（将来） | 冷却候補の把握 |
| `GET /nodes/{id}` | 読み取り（将来） | 個別 Node の context / history / temperature を取得する |

### 3.2 禁止される Skill 呼び出し

| 操作 | 禁止理由 |
|------|---------|
| `estimate-status` の **Apply mode** | status 確定は人間の責務（18 §2.2） |
| `POST /nodes` | Node 作成は人間または Capture の責務 |
| `PATCH /nodes/{id}` | Node 更新は人間の責務 |
| `POST /nodes/{id}/children` | 子 Node 作成は人間の承認を経るべき |
| `POST /nodes/{id}/delegate` | 委任は人間の判断 |
| `POST /nodes/{id}/decision-support` | Advisor 自身がこの Skill の実体。自己呼び出しは循環 |
| DB への直接クエリ | 10_Architecture §2.2 |

---

## 4. 入力

### 4.1 直接入力（Skill / API 経由）

| 入力 | 取得元 | 説明 |
|------|--------|------|
| 対象 Node の詳細 | `GET /nodes/{id}`（将来） | context / history / status / temperature |
| status 推定候補 | `estimate-status` Preview | 遷移の選択肢を案の材料にする |
| アクティブ Node 一覧 | `GET /dashboard/active` | 関連 Node の存在確認 |

### 4.2 間接入力（他サブエージェントの出力）

| 入力 | 取得元 | 説明 |
|------|--------|------|
| ObserverReport | Observer (Level 0) | 状態観測の結果。NEEDS_DECISION の検出結果を受け取る |
| OrganizerReport | Organizer (Level 1) | 構造整理の結果。分解案や関連 Node 情報を判断材料にする |

Observer → Organizer → Advisor の連携は  
18 §4.1（Preview 連鎖許可）に該当する。  
下位 Level の出力はすべて副作用のない提案であり、  
Advisor がそれを入力として受け取ることは安全である。

### 4.3 人間からの明示的な問い

| 入力 | 説明 |
|------|------|
| 「これどうすればいい？」 | 特定 Node の判断支援を依頼する |
| 「A と B のどちらにすべき？」 | 明示的な比較依頼 |
| 「次の一手を考えて」 | 次のアクション候補の生成依頼 |
| 「この文面で大丈夫？」 | 下書きの代替案生成依頼 |

Advisor は人間の問いに応じて動作する。  
自発的に動く場合（NEEDS_DECISION の検出時等）もあるが、  
出力は常に複数案であり、単一の答えは返さない。

---

## 5. 出力

### 5.1 AdvisorReport 型

Advisor の出力は **AdvisorReport** 型で統一する。

```
AdvisorReport {
  // 対象 Node
  target_node_id: string
  target_title: string
  current_status: string

  // 選択肢（必ず 2 つ以上）
  options: [
    {
      label: string           // 案の短い名前（「案A：即決する」等）
      description: string     // 案の詳細説明
      pros: string[]          // この案のメリット
      cons: string[]          // この案のデメリット
      suggested_status: string?  // この案を選んだ場合の status 候補（任意）
    }
  ]

  // 判断の観点（選択肢を比較する軸）
  criteria: [
    {
      name: string            // 観点名（「緊急度」「依存関係」「コスト」等）
      description: string     // この観点が重要な理由
    }
  ]

  // 次に決めるべきこと（1 つだけ）
  next_decision: string       // 「まず◯◯を決めると、他が見えてきます」

  // Advisor の要約（判断ではなく状況整理）
  summary: string             // 「この Node は◯◯の状態にあり、選択肢は以下です」
}
```

### 5.2 出力は「案」であり「答え」ではない

AdvisorReport のすべてのフィールドは**案（option）**である。

| フィールド | 案であること | 答えではないこと |
|-----------|------------|----------------|
| `options` | 「こういう選び方がある」 | 「これが正解」 |
| `criteria` | 「この観点で比較できる」 | 「この観点が最重要」 |
| `next_decision` | 「まずここを決めると進みやすい」 | 「ここを決めてください」 |
| `summary` | 「状況はこう見える」 | 「結論はこうだ」 |

### 5.3 複数案必須ルール（Level 2 の核心）

**Advisor の出力には必ず 2 つ以上の選択肢を含める。**

これは Level 2 の最も重要なルールであり、  
「AI が正解を出した」と人間に感じさせないための構造的ガードである。

| 許可される出力 | 禁止される出力 |
|-------------|--------------|
| 案 A / 案 B / 案 C の 3 択 | 「案 A がベストです」 |
| 「やる」案 / 「やらない」案の 2 択 | 「やるべきです」 |
| 3 つの下書きパターン | 1 つの完成形 |
| 「早い順」「安い順」「確実な順」の 3 シナリオ | 「このシナリオが最適です」 |

**なぜ単一案を禁止するのか**：

- 単一案 = 「AI が判断した」ことと実質同義
- 人間は比較対象がないと「提示された案 = 正解」と受け取りやすい
- 複数案があれば、人間は「どれにするか」を考える = 判断の主導権が人間に残る
- 00_Vision §5.4「思考の主導権が常に人間側にある」を守る最も確実な手段

### 5.4 出力ラベルルール

出力に含まれるすべてのテキストに対して、以下のラベル規則を適用する。

| 要素 | 必ず含めるラベル | 例 |
|------|---------------|-----|
| 選択肢の冒頭 | **「案」「パターン」「候補」** のいずれか | 「案A：すぐ着手する」 |
| 下書き文案 | **「下書き」「たたき台」「素案」** のいずれか | 「【下書き】返信文パターン 1」 |
| 要約の冒頭 | **「現時点では」「〜に見えます」** | 「現時点では、2 つの方向が考えられます」 |

**禁止されるラベル**：「結論」「決定」「最適」「ベスト」「推奨」

「推奨」を禁止する理由：  
「推奨」は「AI がこれを選んだ」と解釈されやすい。  
Advisor は案を**並べる**のが仕事であり、案を**選ぶ**のは人間の仕事である。

### 5.5 語調ルール（Level 1 からの継承＋強化）

Level 1（Organizer）の語調ルールを継承し、さらに厳格化する。

| 使ってよい表現 | 使ってはいけない表現 |
|-------------|-------------------|
| 「〜という案があります」 | 「〜すべきです」 |
| 「〜も考えられます」 | 「〜が正解です」 |
| 「〜と〜を比較できます」 | 「〜が優れています」 |
| 「〜を決めると進みやすくなります」 | 「〜を決めてください」 |
| 「メリットは〜、デメリットは〜」 | 「メリットが大きいので〜」 |

**Level 1 との違い**：  
Level 1 は「断定しない」が主な制約。  
Level 2 は「断定しない」に加え、**「比較を促す」「選択を促す」** 語調を使う。  
「〜に見えます」（Level 1）だけでなく、  
「〜と〜を比較できます」（Level 2）のように、  
人間に能動的な判断を促す表現を意識する。

---

## 6. 処理フロー

### 6.1 判断支援フロー（NEEDS_DECISION 対応）

```
1. Observer / Organizer から NEEDS_DECISION の Node を検出
   または人間から「これどうすればいい？」の指示を受ける
2. GET /nodes/{id} で Node の context / history を取得
3. estimate-status Preview で遷移候補を確認
4. Node の context から「何が判断を止めているか」を分析
5. 選択肢（2 つ以上）を構成し、各案の pros / cons を整理
6. 判断の観点（criteria）を抽出
7. 「次に決めるべきこと」を 1 つ特定
8. AdvisorReport を構成し、人間 UI に返す
```

### 6.2 下書き生成フロー

```
1. 人間から「この文面で大丈夫？」「返信案を考えて」の指示を受ける
2. GET /nodes/{id} で Node の context を取得
3. 文案を複数パターン（2〜3 個）生成
4. 各パターンにラベル（「下書き A」「下書き B」）を付与
5. AdvisorReport.options として返す（pros / cons は文体の違い等）
6. 人間 UI に返す
```

### 6.3 フローの中で「やらない」こと

| ステップ | やること | やらないこと |
|---------|---------|------------|
| 情報取得 | 読み取り | Node の作成・更新 |
| 分析 | context / history の解釈 | status の変更 |
| 案の構成 | 複数案の生成 | 単一案の提示 |
| 評価軸整理 | 観点の列挙 | 観点の重み付け・ランキング |
| next_decision | 「まずここを決める」の特定 | 「こう決める」の指示 |
| 出力 | 案の提示 | 案の自動採用 |

---

## 7. 人間 UI との関係

### 7.1 surfacing の方法

| AdvisorReport の要素 | UI での表示 |
|--------------------|-----------|
| `options` | 選択肢カード一覧。各カードに案の名前・説明・pros / cons を表示 |
| `criteria` | 選択肢の上部に「比較の観点」として表示 |
| `next_decision` | 選択肢の下部に「まず決めること」としてハイライト表示 |
| `summary` | 詳細パネルの冒頭に概況として表示 |

### 7.2 人間の応答パターン

| 提案 | 人間の操作 | 結果 |
|------|-----------|------|
| 選択肢の 1 つを選ぶ | 「この案で進める」ボタン | 案に対応する操作を人間 UI で実行（estimate-status Apply 等） |
| 選択肢を修正する | 案をベースに自分で編集 | 編集後の内容で操作を実行 |
| すべて却下する | 「どれも違う」または無視 | 何も起きない。Advisor に再度問いかけることも可 |
| 下書きを採用する | 下書きテキストをコピー | Node の context 更新等は人間が判断 |

**重要**：Advisor の出力から実行に至るまでに、  
必ず **人間の選択行為**（カードのクリック・テキストの採用）が介在する。  
Advisor → Apply / Node 更新の直接経路は**存在しない**。

### 7.3 「おすすめ」の扱い

Advisor は出力に**「おすすめ」を付けない**。

| やってよいこと | やってはいけないこと |
|-------------|-------------------|
| 案を並べる | 案に星・ランクを付ける |
| 観点を列挙する | 「総合評価」を出す |
| pros / cons を均等に書く | 特定の案だけ pros を多く書く |
| 「まず〜を決めると進む」 | 「〜を選ぶのが賢明」 |

**理由**：  
「おすすめ」は事実上の単一案提示であり、  
§5.3（複数案必須ルール）の精神に反する。  
人間は「おすすめ」があると他の案を読まなくなる傾向があり、  
判断の主導権が AI に移る。

---

## 8. 「提案」と「判断」の境界を担保する仕組み

Advisor が「案を出すが、選ばない」を守る仕組みは、  
Observer の 3 層 + Organizer の語調ルールに加え、  
**複数案構造ルール**を持つ **5 層構造**である。

### Layer 1：Skill 呼び出し制限（Level 0/1 と同一）

Preview / 読み取りのみ。  
Apply / POST / PATCH へのアクセスは設計上排除。

### Layer 2：出力型の制約

AdvisorReport 型は `options`（複数形）を持ち、  
`answer`（単数形）を持たない。  
型レベルで「単一の答え」を表現できない。

### Layer 3：UI 経由の実行フロー

提案から実行に至るには、  
必ず人間の UI 操作（案の選択・テキストの採用）が介在する。

### Layer 4：語調ルール（Level 1 から継承＋強化）

「〜すべき」「正解」「推奨」の禁止。  
「〜という案があります」「比較できます」の語調に限定。

### Layer 5：複数案構造ルール（Level 2 特有）

- 出力に必ず 2 つ以上の選択肢を含める（§5.3）
- 出力に「おすすめ」「ランキング」を含めない（§7.3）
- pros / cons を偏りなく記載する（§7.3）
- 単一の「結論」「最適解」を提示しない

**5 層のすべてが揃って初めて**、  
Advisor は「判断に最も近い位置にいながら、判断をしない」  
という設計を維持できる。

---

## 9. Observer / Organizer との連携パターン

### 9.1 3 段階の協調パターン

```
Observer  → ObserverReport（この Node は NEEDS_DECISION です）
               ↓
Organizer → OrganizerReport（この Node は案件 X と関連しています）
               ↓
Advisor   → AdvisorReport（案 A / 案 B / 案 C が考えられます）
               ↓
人間 UI   → 比較・選択・実行
```

### 9.2 役割の重複がない理由

| 出力 | Observer | Organizer | Advisor |
|------|---------|-----------|---------|
| 「この Node は NEEDS_DECISION です」 | Yes | No | No |
| 「この Node は案件 X と関連しています」 | No | Yes | No |
| 「案 A は〜、案 B は〜」 | No | No | Yes |
| 「まず〜を決めると進みます」 | No | No | Yes |
| 「こう分解できそうです」 | No | Yes | No |
| 「冷えてきています」 | Yes | No | No |

**Advisor だけが「まだ存在しない情報」を出力する。**  
Observer は既にある状態を見る。  
Organizer は既にある Node を並べる。  
Advisor は**まだ言語化されていない選択肢を新たに構成する**。

---

## 10. 将来の拡張

### 10.1 Advisor が使える Skill が増えた場合

`POST /nodes/{id}/decision-support`（09 §12）が  
Skill として実装された場合、Advisor はその **Preview / 読み取り**  
モードのみを利用してよい。

### 10.2 Advisor の出力を他のサブエージェントが使う場合

AdvisorReport を Level 3（Executor）が  
「人間が承認した案を Apply として実行する」入力に使うことは許可する。  
ただし Executor は判断せず、人間が選んだ案をそのまま実行するだけである。

### 10.3 他の Level 2 エージェントを設計するとき

本ドキュメントを**テンプレート**として使う。  
Level 1 テンプレート（21）の全セクションに加え、  
以下の Level 2 固有セクションを必ず含めること。

| 追加セクション | 必須内容 |
|-------------|---------|
| §5.3 複数案必須ルール | 単一案禁止の明文化と理由 |
| §5.4 出力ラベルルール | 「案」「下書き」等の必須ラベルと禁止ラベル |
| §7.3 「おすすめ」の扱い | ランキング・偏り・総合評価の禁止 |
| §8 Layer 5 | 複数案構造ルールの具体的な定義 |

---

## 11. この文書の位置づけ

本ドキュメントは、

- context-os 初の Level 2 サブエージェント設計書
- 将来の Level 2 エージェント設計テンプレート
- 20_SubAgent_Catalog.md §5 の具体化
- 21_SubAgent_Organizer.md との差分定義

として機能する。

Advisor に迷った場合は、  
**「この出力に、人間が選ぶ余地はあるか？」**  
を判断基準とする。  
人間が選ぶ余地のない出力は、Advisor ではなく判断である。
