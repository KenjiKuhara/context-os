# 114 — Phase 状態管理（確定記録）

フェーズの完了状態とエビデンスを一覧し、今後の判断で迷わないよう確定記録する。状態は CLOSED（DONE）になった時点でここに追記する。

---

## 1. Phase 状態一覧

| Phase | 状態 | Evidence | Note |
|-------|------|----------|------|
| **Phase11-E** | **CLOSED（DONE）** | 112, 113 | 実装変更なし、手動E2E結果でクローズ。再出現制御（同 kind 抑制・状態改善で lastHandled 削除・localStorage 異常時も落ちない）を 111 の DoD #1〜#5 および影響なし確認で検証済み。 |

---

## 2. クローズ根拠（Phase11-E）

- docs/112_phase11_e_sage_reappear_e2e_result.md にて手動 E2E 実施済み
- DoD #1〜#5 すべて ✅
- 影響なし確認（Phase11-D 導線・通常トレー・一覧操作）すべて ✅
- docs/113_phase11_e_sage_reappear_closeout.md に結果転記済み
- 実装・閾値・ロジックの変更なし（動作確認のみ）

---

## 3. 次フェーズ候補・確認・リスク（Phase11-E クローズ時点）

### 3.1 クローズ確定の要約（1段落）

Phase11-E（大賢者助言の再出現制御）は、滞留検知のロジック・閾値・優先順位を変更せず、同一 kind の助言をクリック対応した場合は再表示しない仕組みを localStorage（`kuharaos.sage.lastHandled`）で追加した。状態が改善（いずれの条件も閾値未満）したときのみ lastHandled を削除し再出現を許可する。手動 E2E（111 の DoD #1〜#5 および影響なし確認）を 112 に記録し、113 に転記のうえ正式にクローズした。実装・閾値・ロジックの変更は行っておらず、動作確認のみで完了している。

### 3.2 更新した状態一覧（箇条書き）

- Phase11-E = CLOSED（DONE）
- Evidence = 112（E2E 結果）、113（クローズアウト）
- Note = 実装変更なし、手動 E2E 結果でクローズ
- 上記を本ドキュメント（114_phase_status.md）に確定記録した

### 3.3 次フェーズ候補 3 案（優先度付き）

| 優先度 | 候補 | 内容 |
|--------|------|------|
| **P0** | **Phase11-B 表示文言全面見直しの実装** | 108 の対照表・差し替え案・最終レビューに基づき、Node→タスク・開発者語排除・数式表現廃止を反映する。表示文言のみ変更、DB/API 変更なし。 |
| **P1** | **Phase11-A Step2 体験テストの実施** | 106 のチェックリストに沿って実際に操作し、違和感・迷い・改善メモを記録する。文言改善の観察用。 |
| **P2** | **Phase11-C 重要局面メッセージの実装** | 107 の出現条件・50 例・UI 統合方針に基づき、重要局面のみ「マスター」呼称のメッセージを表示する。109 思想に従う。 |

### 3.4 追加確認チェック（必要に応じて・最大 5 項目）

| # | 確認項目 | 目的 |
|---|----------|------|
| 1 | 複数タブで同一 origin の /dashboard を開いたとき、lastHandled の読み書きが競合しないか | localStorage は origin 共有のため、タブ A でクリック→タブ B で再表示判定が変わる可能性の確認 |
| 2 | 助言表示中にブラウザを再起動し、再起動後に同じ条件で /dashboard を開いたとき助言が表示されるか | lastHandled が永続されているため、再起動後も同 kind は抑制される想定の確認 |
| 3 | トレー表示中に他画面へ遷移し、戻ってきたとき助言・トレー・選択状態が整合しているか | 再取得や state の復元が期待どおりか |
| 4 | 同一 origin で他機能（例: ツリー開閉）が同じ localStorage キーを使っていないか | kuharaos.sage.lastHandled 以外との競合がないか |
| 5 | lastHandled に想定外の JSON（別形式・余分なキー）が入っていた場合も parse 失敗で握りつぶし表示されるか | 112 の DoD #4 で不正 JSON は確認済み。他形式の補足確認 |

### 3.5 追加で確認すべき潜在リスク（提案）

| リスク | 内容 | 対応方針 |
|--------|------|----------|
| **複数タブ同時操作** | タブ A で助言をクリックして lastHandled を保存した直後に、タブ B で同じ条件のダッシュボードを表示していると、タブ B は次回描画まで lastHandled を読まない可能性がある。逆にタブ B で先にクリックするとタブ A の表示は変えない。 | 現仕様では「同一タブ内での再表示抑制」が主目的のため、複数タブの完全同期は要求しない。必要なら「ダッシュボードフォーカス時や visibilitychange で trays 再取得＋表示再計算」で緩和可能。 |
| **ブラウザ再起動** | 再起動後も localStorage は残るため、再起動前にクリックした kind は再起動後も抑制される。ユーザーが「再起動したから再度助言が欲しい」と期待する場合は現仕様では叶わない。 | 仕様どおり。状態改善でのみ解除するため、再起動だけでは解除しない。 |
| **トレー表示中の画面遷移** | /dashboard から他ルートへ遷移し、戻ってきたときに refreshDashboard が走り trays が更新される。lastHandled はそのままなので、条件が満たされていれば同 kind は表示されない。 | 想定どおり。特段の対応は不要。 |
| **localStorage 競合** | キーは `kuharaos.sage.lastHandled` のみ。ツリー開閉は `kuharaos.tree.expanded.v1` で別キー。他機能が同じキーを使っていなければ競合しない。 | 現状は競合なし。今後の機能で同一キーを共有しないよう注意。 |
| **想定外 JSON** | 他スクリプトや拡張が誤って key に書き込んだ場合、JSON.parse が失敗し try-catch で null 扱いになり、candidate がそのまま返って助言は表示される。 | 112 DoD #4 で不正 JSON 時は落ちないことを確認済み。想定外の型でも parse 失敗で握りつぶされる。 |

---

## 4. 参照ドキュメント

| 番号 | ファイル名 |
|------|------------|
| 111 | 111_phase11_e_sage_reappear_e2e_plan.md |
| 112 | 112_phase11_e_sage_reappear_e2e_result.md |
| 113 | 113_phase11_e_sage_reappear_closeout.md |

---

以上。Phase11-E の状態を CLOSED として確定記録し、次フェーズ候補・確認チェック・潜在リスクを記載した。
