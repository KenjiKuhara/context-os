# 114 — Phase 状態管理（確定記録）

フェーズの完了状態とエビデンスを一覧し、今後の判断で迷わないよう確定記録する。状態は CLOSED（DONE）になった時点でここに追記する。

---

## 1. Phase 状態一覧

| Phase | 状態 | Evidence | Note |
|-------|------|----------|------|
| **Phase11-E** | **CLOSED（DONE）** | 112, 113 | 実装変更なし、手動E2E結果でクローズ。再出現制御（同 kind 抑制・状態改善で lastHandled 削除・localStorage 異常時も落ちない）を 111 の DoD #1〜#5 および影響なし確認で検証済み。 |
| **Phase11-B** | **CLOSED（DONE）** | 108, 115, 116 | 表示文言全面見直し。Block A/B/C 実装完了。最終横断チェック（116）合格。クローズ根拠: 116 + 115 + 108。 |
| **Phase12-Dark** | **CLOSED（DONE）** | 117, 118, 119 | ダークモード導入。採用案 C: prefers-color-scheme + 手動切替。MVP は /dashboard のみ。Block A〜B（118）完了後、Block C 最終確認（119）で C1〜C5 すべて ✅、MVP 合格。クローズ根拠: 119 + 118 + 117。 |
| **Phase13-UX評価** | **CLOSED（DONE）** | 120 | ダークモード導入後の UX 検証を実施。120 §4〜§6 記入・§8 Exit Criteria 照合で 5 条件すべて満足。違和感 2 件（3 件以下）、誤認 0・誤クリック 0・読みにくい 1 箇所・改善は軽微修正のみ。クローズ根拠: 120。 |
| **Phase14-QuickAdd** | **CLOSED（DONE）** | 121, 122 | 超高速タスク追加UX。1行input+送信ボタン・Enter/ボタン送信・optimistic・二重送信防止（300ms・ボタンのみ非活性）。122で実機体感チェック全項目✅、速度体験の完了条件を満たしたためクローズ。 |
| **Phase15-StatusQuickSwitch** | **CLOSED（DONE）** | 124, 125, 126 | 詳細画面：状態クイック切替ボタン群。全状態常時表示・optimistic・last-write-wins・確認ダイアログなし。126で Exit Criteria 5 項目 ✅、実装完了。 |

---

## 2. クローズ根拠（Phase12-Dark）

- docs/119_phase12_dark_final_check_result.md にて Block C（最終確認）を実施済み
- C1（3 モード切替）・C2（選択保持）・C3（コントラスト）・C4（状態色）・C5（回帰なし）すべて ✅
- MVP 合格とし、Phase12-Dark を CLOSED（DONE）とした
- クローズ根拠ドキュメント: **119（最終確認結果）+ 118（実装タスク・契約・Block ゲート報告）+ 117（設計）**

---

## 2.1 クローズ根拠（Phase14-QuickAdd）

- docs/122_phase14_quick_add_final_check_result.md にて実機体感チェックを実施
- 連続10件マウスなし・ボタン送信・送信中ボタン非活性・二重送信防止・Escクリアの 5 項目を ✅ で記録
- 速度体験の完了条件（待ち感ゼロ・入力が止まらない）を満たしたため、Phase14-QuickAdd を CLOSED（DONE）とした
- クローズ根拠ドキュメント: **122（実機体感チェック結果）+ 121（設計）+ 123（クローズアウト）**

---

## 2.2 クローズ根拠（Phase15-StatusQuickSwitch）

- docs/126_phase15_status_quick_switch_final_check_result.md にて Exit Criteria 5 項目を確認
- 全状態ボタン群常時表示・optimistic・last-write-wins・失敗時ロールバック・既存導線変更なしを実装で満たした
- クローズ根拠ドキュメント: **126（最終確認結果）+ 125（実装タスク）+ 124（設計）**

---

## 3. クローズ根拠（Phase11-B）

- docs/116_phase11_b_final_check_result.md にて最終横断チェック（115 §8）を実施済み
- (1) 全画面スキャン: 開発者語残存 1 件（TreeList aria-label）を修正のち合格
- (2) 表示用語の統一: 108 対照表どおり
- (3) STATUS_LABELS の統一: raw status は画面に出さずラベルのみ表示
- クローズ根拠ドキュメント: **116（横断チェック結果）+ 115（実装タスク・Block 報告）+ 108（対照表・差し替え案・最終レビュー）**

---

## 4. クローズ根拠（Phase11-E）

- docs/112_phase11_e_sage_reappear_e2e_result.md にて手動 E2E 実施済み
- DoD #1〜#5 すべて ✅
- 影響なし確認（Phase11-D 導線・通常トレー・一覧操作）すべて ✅
- docs/113_phase11_e_sage_reappear_closeout.md に結果転記済み
- 実装・閾値・ロジックの変更なし（動作確認のみ）

---

## 5. 次フェーズ候補・確認・リスク（Phase11-E クローズ時点）

### 3.1 クローズ確定の要約（1段落）

Phase11-E（大賢者助言の再出現制御）は、滞留検知のロジック・閾値・優先順位を変更せず、同一 kind の助言をクリック対応した場合は再表示しない仕組みを localStorage（`kuharaos.sage.lastHandled`）で追加した。状態が改善（いずれの条件も閾値未満）したときのみ lastHandled を削除し再出現を許可する。手動 E2E（111 の DoD #1〜#5 および影響なし確認）を 112 に記録し、113 に転記のうえ正式にクローズした。実装・閾値・ロジックの変更は行っておらず、動作確認のみで完了している。

### 3.2 更新した状態一覧（箇条書き）

- Phase11-E = CLOSED（DONE）
- Evidence = 112（E2E 結果）、113（クローズアウト）
- Note = 実装変更なし、手動 E2E 結果でクローズ
- 上記を本ドキュメント（114_phase_status.md）に確定記録した

### 3.3 次フェーズ候補 3 案（優先度付き）

| 優先度 | 候補 | 内容 |
|--------|------|------|
| **P0** | **Phase11-B 表示文言全面見直しの実装** | 108 の対照表・差し替え案・最終レビューに基づき、Node→タスク・開発者語排除・数式表現廃止を反映する。表示文言のみ変更、DB/API 変更なし。 |
| **P1** | **Phase11-A Step2 体験テストの実施** | 106 のチェックリストに沿って実際に操作し、違和感・迷い・改善メモを記録する。文言改善の観察用。 |
| **P2** | **Phase11-C 重要局面メッセージの実装** | 107 の出現条件・50 例・UI 統合方針に基づき、重要局面のみ「マスター」呼称のメッセージを表示する。109 思想に従う。 |

### 3.4 追加確認チェック（必要に応じて・最大 5 項目）

| # | 確認項目 | 目的 |
|---|----------|------|
| 1 | 複数タブで同一 origin の /dashboard を開いたとき、lastHandled の読み書きが競合しないか | localStorage は origin 共有のため、タブ A でクリック→タブ B で再表示判定が変わる可能性の確認 |
| 2 | 助言表示中にブラウザを再起動し、再起動後に同じ条件で /dashboard を開いたとき助言が表示されるか | lastHandled が永続されているため、再起動後も同 kind は抑制される想定の確認 |
| 3 | トレー表示中に他画面へ遷移し、戻ってきたとき助言・トレー・選択状態が整合しているか | 再取得や state の復元が期待どおりか |
| 4 | 同一 origin で他機能（例: ツリー開閉）が同じ localStorage キーを使っていないか | kuharaos.sage.lastHandled 以外との競合がないか |
| 5 | lastHandled に想定外の JSON（別形式・余分なキー）が入っていた場合も parse 失敗で握りつぶし表示されるか | 112 の DoD #4 で不正 JSON は確認済み。他形式の補足確認 |

### 3.5 追加で確認すべき潜在リスク（提案）

| リスク | 内容 | 対応方針 |
|--------|------|----------|
| **複数タブ同時操作** | タブ A で助言をクリックして lastHandled を保存した直後に、タブ B で同じ条件のダッシュボードを表示していると、タブ B は次回描画まで lastHandled を読まない可能性がある。逆にタブ B で先にクリックするとタブ A の表示は変えない。 | 現仕様では「同一タブ内での再表示抑制」が主目的のため、複数タブの完全同期は要求しない。必要なら「ダッシュボードフォーカス時や visibilitychange で trays 再取得＋表示再計算」で緩和可能。 |
| **ブラウザ再起動** | 再起動後も localStorage は残るため、再起動前にクリックした kind は再起動後も抑制される。ユーザーが「再起動したから再度助言が欲しい」と期待する場合は現仕様では叶わない。 | 仕様どおり。状態改善でのみ解除するため、再起動だけでは解除しない。 |
| **トレー表示中の画面遷移** | /dashboard から他ルートへ遷移し、戻ってきたときに refreshDashboard が走り trays が更新される。lastHandled はそのままなので、条件が満たされていれば同 kind は表示されない。 | 想定どおり。特段の対応は不要。 |
| **localStorage 競合** | キーは `kuharaos.sage.lastHandled` のみ。ツリー開閉は `kuharaos.tree.expanded.v1` で別キー。他機能が同じキーを使っていなければ競合しない。 | 現状は競合なし。今後の機能で同一キーを共有しないよう注意。 |
| **想定外 JSON** | 他スクリプトや拡張が誤って key に書き込んだ場合、JSON.parse が失敗し try-catch で null 扱いになり、candidate がそのまま返って助言は表示される。 | 112 DoD #4 で不正 JSON 時は落ちないことを確認済み。想定外の型でも parse 失敗で握りつぶされる。 |

---

## 6. 戦略判断（Phase11-E クローズ後・優先順位確定）

### 4.1 優先度再評価表（スコア付き）

4 観点で 5 点満点。評価基準: プロダクト目的整合性（Vision/PRD との一致）、UX インパクト（体感される変化の大きさ）、技術負債への影響（負債を減らす＋／増やさない）、将来の拡張性（次の変更のしやすさ）。

| 候補 | プロダクト目的整合性 | UX インパクト | 技術負債への影響 | 将来の拡張性 | 合計 |
|------|----------------------|---------------|------------------|--------------|------|
| **P0: Phase11-B 表示文言全面見直しの実装** | 5 | 5 | 4 | 4 | **18** |
| **P1: Phase11-A Step2 体験テストの実施** | 4 | 4 | 3 | 5 | **16** |
| **P2: Phase11-C 重要局面メッセージの実装** | 4 | 4 | 3 | 4 | **15** |

- **Phase11-B**: 「思考の途中を保存し再開する」個人向け OS として、Node→タスク・開発者語排除は目的と直結。全画面が対象のため UX インパクトは最大。表示層の用語を揃えることで技術負債を減らし、今後の文言追加の土台になる。
- **Phase11-A Step2**: 現状文言の違和感を観察し、次の改善の根拠を残す。設計・テスト習慣の拡張性は高いが、単体では画面変更を伴わない。
- **Phase11-C**: 重要局面の人格表示は 109 思想と整合するが、出現は限定的。メッセージ管理の拡張は 107 で設計済み。

### 4.2 今すぐやるべき 1 つ（断定）

**Phase11-B 表示文言全面見直しの実装** を、次に開始する唯一のフェーズとする。

108 の対照表・該当箇所・差し替え案・最終レビューに従い、Node→タスク・開発者語排除・数式表現廃止を全画面に反映する。DB/API 変更なし・表示文言のみ・スコープは 108 で確定済みとする。

### 4.3 選定理由（3 視点）

**経営視点**  
「思考の途中を保存し、再開できる外部ワーキングメモリ OS」を、利用者にそのまま伝えるには、画面が「個人のタスクと状態」の言葉で一貫している必要がある。Node・UUID・READY などの開発者語が残っていると、プロダクトの主張と表示がずれ、信頼と理解を損なう。Phase11-B は、設計済みの 108 を実行するだけで、短期に「何のための OS か」を伝える表現を揃えられる。追加の要件定義や市場検証を待たずに成果を出せる。

**開発効率視点**  
108 で内部語→表示語の対照表・該当箇所・差し替え案・全画面最終レビューが揃っており、実装は置換と STATUS_LABELS の適用に落とし込める。DB/API を触らないため、影響範囲が表示層に限定され、レビューとロールバックが容易である。後から Phase11-A Step2 で体験テストをしても、すでに「タスク」で統一した状態を評価できるため、設計の二度手間にはならない。

**UX 視点**  
いまの利用者は、一覧・詳細・提案パネル・履歴・Observer のどこを開いても、Node・node_id・UUID・READY 等に触れる。初見でも「自分のタスクと状態」として読めるようにするのが Phase11-B の目的であり、全画面を対象にするためインパクトが最も大きい。大賢者助言（Phase11-D/11-E）は滞留時のみの補助であり、日常的に見るラベルとメッセージを先に整える方が、日々の体験改善に直結する。

### 4.4 開始前チェックリスト（Phase11-B 開始用）

**追加ドキュメント**

- Phase11-B 実装タスク一覧（108 §2 該当箇所をファイル・ブロック単位で分解し、差し替え前→差し替え後の対応表にしたもの）。必要なら 115_phase11_b_impl_tasks.md として作成する。

**修正すべき既存ドキュメント**

- 105_phase11_a_ui_text_audit.md: Phase11-A 適用後の現状表記になっているか確認する。もし古い表記のままなら「Phase11-A 適用後」の注記を追記するか、該当箇所を 108 の最終レビュー表記に合わせる。

**事前確認事項**

- 108 §4 全画面最終レビュー表と、page.tsx / ProposalPanel.tsx / TreeList.tsx / stateMachine.ts の実際の表示文言が 1:1 で対応しているか、漏れ・重複がないか確認する。
- フラット一覧・TreeList 行・確認ダイアログで raw の status（READY, IN_PROGRESS 等）を出している箇所を洗い出し、すべて STATUS_LABELS 経由の表示に差し替えることをタスクに含める。
- 108 で「変更しない」としているもの（API キー名・stateMachine の Status 型・既存ラベルのうち Phase11-B 対象外）を一覧し、実装時に変更しないことを確認する。

### 4.5 テスト強化・設計再整理の優先について

**結論: 今は実装（Phase11-B）を優先し、テスト強化や設計再整理は後回しとする。**

**理由**

- 108 で Phase11-B のスコープ（表示文言のみ・DB/API 変更なし・全画面）と差し替え案が確定しており、設計の未整理が実装のボトルネックになっていない。
- Phase11-E では手動 E2E を実施し、大賢者導線と再出現制御が期待どおり動くことを確認済み。文言変更は既存挙動を変えず、差分は表示テキストのみのため、回帰リスクは相対的に小さい。
- 体験テスト（Phase11-A Step2）は、Phase11-B を実施した「タスク・状態」で揃えたあとの状態に対して行う方が、改善案の優先度をつけやすい。先にテストをしても、その直後に 11-B で文言が変わるなら、テスト結果の一部はすぐ陳腐化する。
- 設計の再整理（例: ドメイン用語と表示用語の責務分離を明文化する）は、Phase11-B で「表示用語」を一通り揃えたあとに行う方が、対象範囲と例外が明確になる。

以上のため、「今は実装を進めるよりテスト強化や設計再整理を優先すべき」とは判断しない。Phase11-B を開始し、完了後に Phase11-A Step2 または Phase11-C の優先度を再評価する。

---

## 7. 参照ドキュメント

| 番号 | ファイル名 |
|------|------------|
| 105 | 105_phase11_a_ui_text_audit.md |
| 106 | 106_phase11_a_step2_experience_test_checklist.md |
| 107 | 107_phase11_c_personality_design.md |
| 108 | 108_phase11_b_display_copy_review.md |
| 109 | 109_phase11_c_os_philosophy.md |
| 111 | 111_phase11_e_sage_reappear_e2e_plan.md |
| 112 | 112_phase11_e_sage_reappear_e2e_result.md |
| 113 | 113_phase11_e_sage_reappear_closeout.md |
| 115 | 115_phase11_b_impl_tasks.md |
| 116 | 116_phase11_b_final_check_result.md |
| 117 | 117_dark_mode_design.md |
| 118 | 118_dark_mode_impl_tasks.md |
| 119 | 119_phase12_dark_final_check_result.md |
| 120 | 120_phase13_dark_ux_validation.md |
| 121 | 121_phase14_quick_add_design.md |
| 122 | 122_phase14_quick_add_final_check_result.md |
| 123 | 123_phase14_quick_add_closeout.md |
| 124 | 124_phase15_status_quick_switch_design.md |
| 125 | 125_phase15_status_quick_switch_impl_tasks.md |
| 126 | 126_phase15_status_quick_switch_final_check_result.md |

---

## 8. 次フェーズ候補（Phase12-Dark クローズ時点）

Phase12-Dark は /dashboard のみを MVP とした。未対応の拡張は次フェーズ候補として残す。

| 候補 | 内容 |
|------|------|
| **全ページ展開** | 他ルート（/ 等）へテーマ切替を展開。localStorage は既に共有のため、layout と各ページのトークン適用が主な作業。 |
| **high-contrast テーマ** | 117・118 で data-theme 拡張可能と設計済み。必要に応じて theme-tokens.css に `html[data-theme="high-contrast"]` を追加。 |
| **キー操作・アクセシビリティ** | テーマ切替のキーボード操作や prefers-reduced-motion 等の配慮は本 MVP では未実施。 |

---

## 9. 次フェーズ候補（Phase14-QuickAdd クローズ時点）— 入力導線の拡張

Phase14 の速度体験は壊さない前提で、以下を優先度順に提案する。

| 優先度 | 候補 | 内容 |
|--------|------|------|
| **P0** | **「子として追加」を 1 秒で** | 親選択中なら parent_id を自動付与し、QuickAdd から子ノードを 1 秒で追加できる導線。 |
| **P1** | **インボックス/下書き概念** | READY 以外の CAPTURED 導線の整理（インボックス・下書きなどの整理 UX）。 |
| **P2** | **QuickAdd 履歴** | 直近追加 5 件の Undo / 再編集。Phase14 の連続入力体験を損なわない範囲で。 |

---

以上。Phase11-E の状態を CLOSED として確定記録し、Phase11-B は 116 の最終横断チェック合格に基づき CLOSED（DONE）とした。次フェーズ候補・確認チェック・潜在リスク・戦略判断を記載した。
