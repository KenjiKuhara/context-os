# 04_Domain_Model.md  
## Domain Model Specification for context-os

---

## 0. この文書の役割

本ドキュメントは、context-osにおける  
**ドメインモデル（概念・用語・構造）を唯一の正として定義**する。

- 「何が存在するか」
- 「何が存在しないか」
- 「どういう関係が許されるか」

を固定し、  
以後の設計・実装・プロンプトにおける  
**概念のブレを防ぐこと**を目的とする。

本ドキュメントは以下を前提とする。

- `00_Vision_NorthStar.md`
- `01_PRD.md`
- `05_State_Machine.md`
- `06_Temperature_Spec.md`

---

## 1. 基本方針（最重要）

### 1.1 オブジェクトは1種類のみ

context-osに存在する中核オブジェクトは  
**Node（ノード）1種類のみ**である。

- タスク
- 思考
- 作業
- メモ
- アイデア
- 途中の判断

これらを**型で分けない**。

違いはすべて  
**「いまどんな状態にあるか」**  
で表現する。

---

### 1.2 Nodeは「思考の外部コンテナ」である

Nodeとは、

> 人間の思考・作業・判断の  
> **途中状態を安全に外部化するための最小単位**

である。

Nodeは「完了させるため」に存在するのではなく、  
**「中断しても再開できるようにするため」**に存在する。

---

## 2. Nodeのライフサイクル上の役割

Nodeは、以下のような役割を**状態によって持つ**。

- CAPTURED：とりあえず置かれた思考
- CLARIFYING：意味を詰めている思考
- READY：着手可能な作業
- IN_PROGRESS：実施中の作業
- NEEDS_DECISION：判断待ちの思考
- DONE：完了した作業
- CANCELLED：やらないと決めた思考

※役割は固定ではなく、状態により変化する。

---

## 3. Nodeが持つ主要属性（概念）

### 3.1 論理属性（必須）

- `id`  
  Nodeを一意に識別するID

- `title`  
  Nodeを一言で表す短い名称

- `context`  
  思考・作業・判断の途中内容  
  再開時に最も重要な情報

**`note` との関係（実装上の整理）**

DB に存在する `note` カラムは PoC 由来の属性であり、  
ドメインモデルの正式な属性ではない。

- `context` が Node の途中内容の**正（SSOT）**である
- `note` は DB 互換として**読み取りのみ**サポートする
- 新規実装で `note` への書き込みは行わない
- intent（何が起きたか）の入力内容は、  
  `node_status_history` の reason に記録し、`note` には書き込まない

この判断の背景：  
PoC 段階で `note` が追加されたが、  
04_Domain_Model が定義する Node の主要属性は title / context / status / temperature であり、  
途中内容の記録先は `context` に統一する。

---

### 3.2 状態関連属性

- `status`  
  現在の作業局面  
  定義は `05_State_Machine.md` に従う

- `temperature`  
  関心・接触頻度の内部スコア  
  定義は `06_Temperature_Spec.md` に従う

---

### 3.3 構造関連属性

- `parent_id`  
  親NodeのID  
  階層構造（ツリー）を形成する

- `sibling_order`  
  同一階層内での並び順  
  UI・再開順のために使用する

---

### 3.4 関係性属性（参照）

- `relations`  
  他のNodeとの関連・参照関係  
  ※ツリー構造とは**別系統**で扱う

---

### 3.5 履歴・観測用属性

- `history`  
  状態・温度の変化ログ

- `events`  
  外部イベント・言及・再燃トリガー

**実装上の扱い（MVP）**

MVP では `events` 専用テーブルを設けず、  
`node_status_history` テーブルが以下の 2 種のレコードを含む。

1. **真の状態遷移**：`from_status ≠ to_status`  
   status が実際に変わったことを記録する
2. **状態変化なしの event**：`from_status === to_status`  
   メモ・判断・文脈の記録など、status は変わらないが  
   意味のある変化（intent / reason）を event として残す

この設計の背景：  
「status が変わらなくても、意味のある変化は必ず残す」が  
context-os の原則であり、  
event をすべて捨てるよりも history に混在させる方が  
情報の損失リスクが低い。

**将来の分離指針**  
`node_events` テーブルを導入する場合は、  
`from_status === to_status` のレコードを events に移行する。  
移行時の識別キーは `from_status === to_status` の等価判定で十分である。

---

## 4. 階層構造（ツリー）の設計

### 4.1 階層の意味

Nodeの階層は、

> 作業や思考の「分解関係」

を表す。

例：

- 講演A
  - 構成を考える
  - スライドを作る
  - トークスクリプトを書く

---

### 4.2 設計原則

- Nodeは **parent_id のみを持つ**
- 子Nodeを配列で持たない
- 子の取得は `parent_id` で検索する

※RDBの得意領域に委ねる。

---

### 4.3 親子関係のルール

- 親Nodeが DONE の場合、子Nodeはすべて DONE である必要がある
- 親Nodeが CANCELLED の場合、子Nodeも原則 CANCELLED とする
- 子Nodeが IN_PROGRESS の場合、親Nodeは READY 以上である

※実装上の自動更新は慎重に行う。

---

## 5. 参照関係（グラフ）の設計

### 5.1 参照とは何か

参照とは、

> 「このNodeは、あのNodeと文脈的に関係している」

という意味的なつながりを表す。

例：
- 同じ顧客に関する別案件
- 同じ資料を参照する複数作業
- 以前の判断との関係

---

### 5.2 ツリーと参照を混ぜない

- ツリー：親子・分解
- 参照：意味的関連

これらを混ぜると、
構造が破綻し、再開できなくなる。

---

### 5.3 参照の扱い方針

- 参照は別テーブル（relations）で管理する
- 双方向である必要はない
- 参照は状態遷移を強制しない

---

## 6. Nodeに「持たせないもの」

Nodeには以下を持たせない。

- 業務固有の型（講演Nodeなど）
- 固定的な優先度ランク
- 人事・評価・監視情報
- 実行ロジック

---

## 7. Nodeと人・AIの関係

### 7.1 人の役割
- 思考を投げる
- 再開する
- 判断する
- 修正する

---

### 7.2 AIの役割
- Node化する
- 状態を推定する
- 温度を算出する
- 再開の入口を提示する

---

## 8. このドメインモデルの目的

このドメインモデルの目的は、

- 厳密な管理  
ではなく  
- **思考の自由度を守ること**

である。

Nodeは思考を縛るための箱ではなく、  
**思考を途中で安全に置くための場所**である。

---

## 9. 本ドキュメントの位置づけ

本ドキュメントは、

- 実装時のデータ設計
- API設計
- プロンプト設計

すべてにおいて参照される  
**ドメインの単一正解（Single Source of Truth）**である。

概念に迷った場合は、  
必ず本ドキュメントに立ち返る。


