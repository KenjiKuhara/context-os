# 74 — Phase6-B ツリー開閉状態の永続化 クローズアウト

**Phase6-B MVP（ツリー開閉状態の永続化）を「完了」として正式にクローズする。** 証跡は 73、計画は 72 を参照する。本ドキュメントはプロジェクト管理上の区切りとしての終了札とする。

---

## 1. 完了宣言

- **Phase6-B MVP（ツリー開閉状態の永続化）は完了した。**
- ツリー表示時の開閉状態（expandedSet）を localStorage（キー `kuharaos.tree.expanded.v1`）に保存し、リロード・再訪問時に復元する。フラット表示時は保存・復元の対象外。72 の Definition of Done に基づく手動確認を 73 に記録した。

---

## 2. Definition of Done に基づく完了確認表（72 準拠）

| # | 条件 | 結果 |
|---|------|------|
| 1 | ツリーでいくつかノードを開き、F5 リロード後も開いたままになっている | ✅ |
| 2 | ツリーでノードを閉じ、リロード後も閉じた状態が維持されている | ✅ |
| 3 | 別タブまたは再度 /dashboard に遷移して戻ったとき、開閉状態が復元されている | ✅ |
| 4 | 開閉状態を変更したあと、localStorage にキーで配列が保存されていることを DevTools 等で確認できる | ✅ |
| 5 | 存在しないノード ID が localStorage に含まれていても、読み込み時にエラーにならず存在する ID だけが展開される | ✅ |
| 6 | Phase6-A の挙動が壊れていない（フラット／ツリー切替、キーボード、詳細パネル連携） | ✅ |

**以上を手動で 1 回実施し、満たした時点で本テーマの MVP を完了とする。** 全項目 OK。

---

## 3. MVP の割り切り事項

以下は Phase6-B 本テーマの範囲外であり、クローズ時点で未対応である。

| 項目 | 内容 |
|------|------|
| **localStorage のみ** | 保存先はブラウザの localStorage のみ。サーバ・DB には保存しない。 |
| **サーバ保存なし** | 開閉状態を API で送信したり DB に書き込んだりしない。 |
| **デバイス間同期なし** | 別ブラウザ・別端末との開閉状態の同期は行わない。同一ブラウザ・同一オリジン内でのみ有効。 |
| **Undo** | 開閉操作の取り消しや「ひとつ前の開閉状態に戻す」は行わない。 |
| **トレー別の開閉** | トレー切替ごとに別の開閉状態を保存せず、1 キーで 1 セットの expanded を保持する。 |
| **debounce / throttle** | 開閉変更の都度すぐに保存する。遅延書き込みは行わない。 |

---

## 4. 次フェーズへの引き継ぎ案

Phase6-B の 2 本目以降、または別 Phase で検討しうるテーマを以下に挙げる。

| 候補 | 内容 |
|------|------|
| **サーバ側永続化** | 開閉状態を API で送信し、ユーザーまたはワークスペースに紐づけて DB に保存する。ログイン前提で「どの端末でも同じ開閉」を実現する。 |
| **ユーザー／ワークスペース単位のキー分離** | localStorage キーをユーザー ID やワークスペース ID で分け、複数アカウント・複数ワークスペースで開閉状態を切り替えて保持する。 |
| **debounce / throttle** | 開閉の連続操作時に保存回数を減らし、最後の状態だけを書き込む。 |
| **複数デバイス同期** | サーバ保存と組み合わせ、別端末で開いた /dashboard でも同じ開閉状態が復元されるようにする。 |

---

**以上をもって Phase6-B ツリー開閉状態の永続化 MVP をクローズする。**
