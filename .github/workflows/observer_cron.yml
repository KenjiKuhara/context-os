# Phase 3-2: Observer 定期実行（GitHub Actions）
#
# Python Observer を cron で実行し、Vercel 上の POST /api/observer/reports に保存する。
# Vercel には Python を載せない。Observer は外部ジョブとして実行する。
#
# 必要な Secrets: NEXT_BASE_URL, OBSERVER_TOKEN（設定手順は docs/27_Observer_Operations.md）

name: Observer Cron

on:
  schedule:
    # 1時間ごと（UTC）。運用に慣れたら 15分に変更可能（例: "*/15 * * * *"）
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  observe-and-save:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r agent/observer/requirements.txt

      - name: Run Observer and save report
        env:
          NEXT_BASE_URL: ${{ secrets.NEXT_BASE_URL }}
          OBSERVER_TOKEN: ${{ secrets.OBSERVER_TOKEN }}
        run: python3 agent/observer/main.py --save
        # Secrets はログに出力されない（GitHub がマスクする）。直書き禁止。
